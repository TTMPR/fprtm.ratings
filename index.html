<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPRTM ‚Äî Sistema de Ratings y Membres√≠a</title>
<link rel="icon" type="image/png" href="ttm_pr_favicon_32x32.png">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
  :root {
    --navy: #0a1628;
    --navy2: #0f2040;
    --blue: #1a3a6e;
    --accent: #e8b84b;
    --accent2: #f4d078;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f97316;
    --text: #f0f4ff;
    --muted: #8899bb;
    --border: rgba(255,255,255,0.08);
    --card: rgba(255,255,255,0.04);
    --card2: rgba(255,255,255,0.07);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--navy);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* BG texture */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 10% 0%, rgba(26,58,110,0.4) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 90% 100%, rgba(232,184,75,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,22,40,0.95);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }

  .logo {
    display: flex; flex-direction: column; align-items: flex-start; gap: 4px;
  }
  .fprtm-logo-img {
    height: 52px; width: auto; display: block; object-fit: contain;
  }
  .fprtm-logo-sub {
    font-size: 10px; letter-spacing: 2px; color: var(--muted);
    text-transform: uppercase; font-weight: 600;
  }

  nav { display: flex; gap: 4px; }
  nav button {
    background: none; border: none; color: var(--muted);
    padding: 8px 16px; border-radius: 8px; cursor: pointer;
    font-family: 'DM Sans'; font-size: 14px; font-weight: 500;
    transition: all 0.2s;
  }
  nav button:hover { color: var(--text); background: var(--card2); }
  nav button.active { color: var(--accent); background: rgba(232,184,75,0.1); }

  .admin-btn {
    background: var(--accent) !important;
    color: var(--navy) !important;
    font-weight: 700 !important;
    padding: 8px 20px !important;
  }
  .admin-btn:hover { background: var(--accent2) !important; }

  /* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
  .page { display: none; position: relative; z-index: 1; }
  .page.active { display: block; animation: fadeUp 0.3s ease; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 40px 32px; }

  /* ‚îÄ‚îÄ‚îÄ PAGE HERO ‚îÄ‚îÄ‚îÄ */
  .page-hero {
    padding: 48px 32px 32px;
    max-width: 1200px; margin: 0 auto;
  }
  .page-hero .overline {
    font-family: 'DM Mono'; font-size: 11px; letter-spacing: 3px;
    color: var(--accent); text-transform: uppercase; margin-bottom: 8px;
  }
  .page-hero h1 {
    font-family: 'Bebas Neue'; font-size: 56px; letter-spacing: 3px;
    line-height: 1; color: var(--text);
  }
  .page-hero p { color: var(--muted); margin-top: 8px; font-size: 15px; }

  /* ‚îÄ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ‚îÄ */
  .search-wrap {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 32px;
  }
  .search-box {
    display: flex; gap: 12px; align-items: center;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 20px;
    transition: border-color 0.2s;
  }
  .search-box:focus-within { border-color: var(--accent); }
  .search-box input {
    background: none; border: none; outline: none;
    color: var(--text); font-family: 'DM Sans'; font-size: 15px;
    flex: 1;
  }
  .search-box input::placeholder { color: var(--muted); }
  .search-icon { color: var(--muted); font-size: 18px; }

  /* ‚îÄ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ */
  .filters {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 24px;
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .filter-chip {
    padding: 6px 16px; border-radius: 99px;
    border: 1px solid var(--border);
    background: var(--card); color: var(--muted);
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.2s;
  }
  .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
  .filter-chip.on { background: rgba(232,184,75,0.15); border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 32px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px;
  }
  .stat-card .label { font-size: 12px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .stat-card .value { font-family: 'Bebas Neue'; font-size: 36px; color: var(--text); line-height: 1; }
  .stat-card .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .stat-card.gold { border-color: rgba(232,184,75,0.3); }
  .stat-card.gold .value { color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ PLAYER GRID ‚îÄ‚îÄ‚îÄ */
  .player-grid {
    max-width: 1200px; margin: 0 auto; padding: 0 32px;
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
  }

  .player-card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
    border: 1px solid var(--border);
    border-radius: 14px; padding: 0;
    display: grid; grid-template-columns: 86px 1fr auto; gap: 16px;
    align-items: center;
    cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .player-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px; background: transparent; transition: background 0.2s;
  }
  .player-card:hover { background: var(--card2); border-color: rgba(255,255,255,0.18); transform: translateY(-1px); }
  .player-card:hover::before { background: var(--accent); }

  .rank-num {
    font-family: 'Bebas Neue'; font-size: 30px; color: var(--muted);
    min-width: 36px; text-align: left; line-height: 1; margin-bottom: 4px;
  }
  .rank-num.top3 { color: var(--accent); }

  .avatar-wrap {
    height: 100%; min-height: 112px;
    background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.06));
    border-right: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
  }
  .avatar {
    width: 54px; height: 54px; border-radius: 50%;
    background: linear-gradient(135deg, var(--blue), var(--navy2));
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 20px; color: var(--accent);
    flex-shrink: 0;
  }

  .player-info { flex: 1; min-width: 0; padding: 14px 0; }
  .player-name { font-weight: 700; font-size: 30px; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Bebas Neue'; letter-spacing: 1px; }
  .player-meta { font-size: 12px; color: var(--muted); margin-top: 6px; }

  .player-right { text-align: right; flex-shrink: 0; padding: 14px 20px 14px 0; }
  .rating-num {
    font-family: 'Bebas Neue'; font-size: 28px; color: var(--text);
    display: flex; align-items: center; gap: 6px; justify-content: flex-end;
  }
  .star { color: var(--accent); font-size: 16px; }
  .player-stats { font-size: 11px; color: var(--muted); margin-top: 2px; font-family: 'DM Mono'; }

  .badge {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600;
    margin-left: 6px;
  }

  /* ‚îÄ‚îÄ‚îÄ PLAYER PROFILE ‚îÄ‚îÄ‚îÄ */
  #profilePage { display: none; }
  #profilePage.active { display: block; }

  .profile-hero {
    max-width: 1200px; margin: 0 auto; padding: 40px 32px;
    display: grid; grid-template-columns: 280px 1fr; gap: 32px; align-items: start;
  }

  .profile-card {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 24px; text-align: center;
  }
  .profile-avatar {
    width: 100px; height: 100px; border-radius: 50%;
    background: linear-gradient(135deg, var(--blue), var(--accent));
    margin: 0 auto 16px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 36px; color: white;
    border: 3px solid var(--accent);
  }
  .profile-name { font-family: 'Bebas Neue'; font-size: 32px; letter-spacing: 1px; line-height: 1.1; }
  .profile-id { font-family: 'DM Mono'; font-size: 13px; color: var(--accent); margin-top: 4px; }
  .profile-club { font-size: 13px; color: var(--muted); margin-top: 6px; }

  .profile-rating-box {
    margin: 24px 0; padding: 20px;
    background: var(--navy);
    border-radius: 12px; border: 1px solid var(--border);
  }
  .profile-rating-box .big-rating {
    font-family: 'Bebas Neue'; font-size: 64px; color: var(--text); line-height: 1;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .profile-rating-box .rating-label { font-size: 12px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

  .profile-quick-stats {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;
  }
  .qs { background: var(--navy); border-radius: 8px; padding: 12px;
    font-size: 13px; color: var(--muted); }
  .qs strong { display: block; font-family: 'Bebas Neue'; font-size: 24px; color: var(--text); }

  .profile-right { }
  .profile-tabs {
    display: flex; gap: 4px; border-bottom: 1px solid var(--border);
    padding-bottom: 0; margin-bottom: 24px;
  }
  .ptab {
    background: none; border: none; color: var(--muted);
    padding: 10px 20px 14px; cursor: pointer;
    font-family: 'DM Sans'; font-size: 14px; font-weight: 500;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all 0.2s;
  }
  .ptab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .ptab-content { display: none; }
  .ptab-content.active { display: block; }

  /* overview stats */
  .overview-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;
  }
  .ov-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px; text-align: center;
  }
  .ov-card .lbl { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .ov-card .val { font-family: 'Bebas Neue'; font-size: 36px; margin-top: 4px; }
  .val.green { color: var(--green); }
  .val.red { color: var(--red); }
  .val.gold { color: var(--accent); }

  /* win % circle */
  .winpct-row { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
  .circle-wrap { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
  .circle-wrap svg { transform: rotate(-90deg); }
  .circle-val {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 18px; color: var(--accent);
  }

  /* tournament history */
  .tourn-list { display: flex; flex-direction: column; gap: 10px; }
  .tourn-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px;
    display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;
  }
  .tourn-name { font-weight: 600; font-size: 14px; }
  .tourn-date { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .tourn-right { text-align: right; }
  .rating-change {
    font-family: 'DM Mono'; font-size: 14px; font-weight: 600;
  }
  .rating-change.up { color: var(--green); }
  .rating-change.dn { color: var(--red); }
  .tourn-matches { font-size: 12px; color: var(--muted); margin-top: 3px; }

  /* match list */
  .match-list { display: flex; flex-direction: column; gap: 8px; }
  .match-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 20px;
    display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;
  }
  .match-player { }
  .match-player .name { font-size: 13px; font-weight: 600; }
  .match-player .rating-tag { font-size: 11px; color: var(--muted); font-family: 'DM Mono'; }
  .match-player .pts-change { font-family: 'DM Mono'; font-size: 12px; font-weight: 700; }
  .match-player.winner .name { color: var(--accent); }
  .match-player.winner .pts-change { color: var(--green); }
  .match-player.loser .pts-change { color: var(--red); }
  .match-center { text-align: center; }
  .match-score { font-family: 'Bebas Neue'; font-size: 18px; color: var(--text); letter-spacing: 2px; }
  .match-date { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .match-player.right { text-align: right; }

  /* ‚îÄ‚îÄ‚îÄ RATING CALCULATOR ‚îÄ‚îÄ‚îÄ */
  .calc-wrap {
    max-width: 800px; margin: 0 auto; padding: 0 32px 40px;
  }

  .manual-entry {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px;
  }
  .manual-entry h3 { font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 2px; margin-bottom: 20px; }

  .match-entry {
    display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 12px; align-items: end;
    margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
  }
  .match-entry:last-of-type { border-bottom: none; }

  .field-group label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 6px; }
  .field-group input, .field-group select {
    width: 100%; background: var(--navy); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 12px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
    transition: border-color 0.2s;
  }
  .field-group input:focus, .field-group select:focus { border-color: var(--accent); }
  .field-group select option { background: var(--navy); }

  .vs-badge {
    font-family: 'Bebas Neue'; font-size: 18px; color: var(--muted);
    padding-bottom: 10px; letter-spacing: 2px;
  }
  .winner-select { align-self: end; }
  .winner-select select { background: var(--navy); }

  .calc-result {
    margin-top: 20px; padding: 20px 24px;
    background: rgba(232,184,75,0.08); border: 1px solid rgba(232,184,75,0.3);
    border-radius: 12px; display: none;
  }
  .calc-result.show { display: block; }
  .calc-result h4 { font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 2px; color: var(--accent); margin-bottom: 12px; }
  .result-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .result-row:last-child { border-bottom: none; }
  .result-player { font-size: 14px; }
  .result-pts { font-family: 'DM Mono'; font-size: 16px; font-weight: 700; }
  .result-pts.gain { color: var(--green); }
  .result-pts.loss { color: var(--red); }

  .btn-primary {
    background: var(--accent); color: var(--navy);
    border: none; border-radius: 10px; padding: 12px 28px;
    font-family: 'DM Sans'; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: all 0.2s; margin-top: 16px;
  }
  .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--card2); color: var(--text);
    border: 1px solid var(--border); border-radius: 10px; padding: 12px 28px;
    font-family: 'DM Sans'; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; margin-top: 16px; margin-left: 8px;
  }
  .btn-secondary:hover { border-color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ CALC TABS ‚îÄ‚îÄ‚îÄ */
  .calc-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
  .calc-tab {
    background: var(--card2); color: var(--muted);
    border: 1px solid var(--border); border-radius: 10px; padding: 10px 22px;
    font-family: 'DM Sans'; font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.2s;
  }
  .calc-tab.active { background: rgba(232,184,75,0.1); color: var(--accent); border-color: rgba(232,184,75,0.4); }
  .calc-tab:hover:not(.active) { border-color: var(--accent); color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ CSV UPLOAD ‚îÄ‚îÄ‚îÄ */
  .csv-drop-area {
    border: 2px dashed var(--border); border-radius: 12px; padding: 40px 20px;
    text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s;
  }
  .csv-drop-area:hover, .csv-drop-area.drag-over { border-color: var(--accent); background: rgba(232,184,75,0.04); }
  .csv-drop-area .upload-icon { font-size: 40px; margin-bottom: 12px; }
  .csv-drop-area .upload-label { color: var(--text); font-size: 15px; margin-bottom: 6px; font-weight: 500; }
  .csv-drop-area .upload-hint { color: var(--muted); font-size: 13px; }

  /* ‚îÄ‚îÄ‚îÄ MEMB SEARCH ‚îÄ‚îÄ‚îÄ */
  .memb-search-wrap { padding: 0 32px; margin-bottom: 16px; }
  .memb-search-wrap input {
    width: 100%; max-width: 360px; box-sizing: border-box;
    background: var(--card2); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 16px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
  }
  .memb-search-wrap input:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ PROFILE TOURNAMENT HISTORY TABLE ‚îÄ‚îÄ‚îÄ */
  .hist-table {
    width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 4px;
  }
  .hist-table th {
    font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
    color: var(--muted); padding: 8px 10px; text-align: left;
    border-bottom: 1px solid var(--border); white-space: nowrap;
  }
  .hist-table td {
    padding: 10px; border-bottom: 1px solid var(--border); vertical-align: middle;
  }
  .hist-table tr:last-child td { border-bottom: none; }
  .hist-t-name {
    font-weight: 600; cursor: pointer; color: var(--text);
    transition: color 0.2s;
  }
  .hist-t-name:hover { color: var(--accent); }
  .hist-wl { display: flex; gap: 5px; align-items: center; }
  .wl-chip {
    padding: 2px 7px; border-radius: 5px; font-size: 11px; font-weight: 700;
  }
  .wl-chip.w { background: rgba(34,197,94,0.15); color: var(--green); }
  .wl-chip.l { background: rgba(239,68,68,0.15); color: var(--red); }
  .hist-delta {
    font-family: 'DM Mono'; font-size: 12px; font-weight: 700;
    padding: 2px 8px; border-radius: 5px;
  }
  .hist-delta.gain { color: var(--green); background: rgba(34,197,94,0.12); }
  .hist-delta.loss { color: var(--red);   background: rgba(239,68,68,0.12); }
  .hist-delta.tie  { color: var(--muted); }
  .hist-rating-post { font-family: 'DM Mono'; font-size: 14px; font-weight: 700; }
  .progress-chart-wrap {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 16px 12px; margin-bottom: 16px;
  }
  .progress-chart-wrap canvas { max-height: 150px; }

  /* ‚îÄ‚îÄ‚îÄ TORNEO ADMIN ACTIONS ‚îÄ‚îÄ‚îÄ */
  .torneo-admin-actions {
    display: flex; gap: 5px; margin-top: 8px; justify-content: flex-end;
  }
  .torneo-admin-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 4px 9px; cursor: pointer; font-size: 14px; line-height: 1;
    transition: background 0.2s, border-color 0.2s;
  }
  .torneo-admin-btn.edit:hover { background: rgba(232,184,75,0.15); border-color: var(--accent); }
  .torneo-admin-btn.del:hover  { background: rgba(239,68,68,0.15);  border-color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ TORNEOS LIST PAGE ‚îÄ‚îÄ‚îÄ */
  .torneos-grid {
    max-width: 900px; margin: 0 auto; padding: 0 32px 40px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .torneo-card {
    background: var(--card2); border: 1px solid var(--border);
    border-radius: 14px; padding: 20px 24px;
    display: flex; align-items: center; justify-content: space-between;
    cursor: pointer; transition: border-color 0.2s, background 0.2s;
    gap: 16px;
  }
  .torneo-card:hover { border-color: var(--accent); background: rgba(232,184,75,0.04); }
  .torneo-card-left { flex: 1; min-width: 0; }
  .torneo-card-name { font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 2px; }
  .torneo-card-date { font-size: 13px; color: var(--muted); margin-top: 4px; }
  .torneo-card-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
  .torneo-card-count { font-family: 'DM Mono'; font-size: 22px; font-weight: 700; color: var(--accent); }
  .torneo-card-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

  /* ‚îÄ‚îÄ‚îÄ TORNEO EVENTO PAGE ‚îÄ‚îÄ‚îÄ */
  .evento-header {
    max-width: 900px; margin: 0 auto 24px; padding: 0 32px;
    display: flex; align-items: flex-start; justify-content: space-between; gap: 16px;
  }
  .evento-meta { font-size: 13px; color: var(--muted); margin-top: 6px; }
  .evento-search-wrap { padding: 0 32px; max-width: 900px; margin: 0 auto 16px; }
  .evento-search-wrap input {
    width: 100%; box-sizing: border-box;
    background: var(--card2); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 16px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
  }
  .evento-search-wrap input:focus { border-color: var(--accent); }
  .evento-grid {
    max-width: 900px; margin: 0 auto; padding: 0 32px 40px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .evento-row {
    background: var(--card2); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px;
    display: flex; align-items: center; gap: 16px;
  }
  .evento-rank {
    font-family: 'DM Mono'; font-size: 13px; color: var(--muted);
    width: 28px; text-align: center; flex-shrink: 0;
  }
  .evento-player { flex: 1; min-width: 0; }
  .evento-player-name { font-weight: 600; font-size: 15px; }
  .evento-player-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .evento-rating-flow { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
  .evento-rating-val { font-family: 'DM Mono'; font-size: 14px; }
  .evento-arrow { color: var(--muted); font-size: 14px; }
  .evento-delta {
    font-family: 'DM Mono'; font-size: 14px; font-weight: 700;
    padding: 3px 8px; border-radius: 6px; flex-shrink: 0;
  }
  .evento-delta.gain { color: var(--green); background: rgba(34,197,94,0.12); }
  .evento-delta.loss { color: var(--red);   background: rgba(239,68,68,0.12); }
  .evento-delta.tie  { color: var(--muted); background: var(--card); }
  .evento-record { font-size: 12px; flex-shrink: 0; text-align: right; }
  .evento-record .w { color: var(--green); }
  .evento-record .l { color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ MEMBRES√çA ‚îÄ‚îÄ‚îÄ */
  .memb-grid {
    max-width: 1200px; margin: 0 auto; padding: 0 32px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .memb-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px;
    display: grid; grid-template-columns: auto 1fr auto auto auto; gap: 16px; align-items: center;
  }
  .memb-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--blue);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 16px; color: var(--accent);
  }
  .memb-name { font-weight: 600; font-size: 14px; }
  .memb-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .memb-date { font-family: 'DM Mono'; font-size: 13px; color: var(--muted); text-align: right; }
  .memb-date .date { font-size: 12px; }
  .status-pill {
    padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 700;
    white-space: nowrap;
  }
  .status-pill.active { background: rgba(34,197,94,0.15); color: var(--green); }
  .status-pill.warning { background: rgba(249,115,22,0.15); color: var(--orange); }
  .status-pill.expired { background: rgba(239,68,68,0.15); color: var(--red); }

  .alert-banner {
    max-width: 1200px; margin: 0 auto 24px;
    padding: 0 32px;
  }
  .alert-box {
    background: rgba(249,115,22,0.1); border: 1px solid rgba(249,115,22,0.3);
    border-radius: 12px; padding: 14px 20px;
    display: flex; align-items: center; gap: 12px;
    font-size: 14px;
  }
  .alert-box .icon { font-size: 20px; }
  .alert-box strong { color: var(--orange); }

  /* ‚îÄ‚îÄ‚îÄ EDIT MEMBER BUTTON & MODAL ‚îÄ‚îÄ‚îÄ */
  .edit-btn {
    background: none; border: 1px solid var(--border);
    border-radius: 6px; padding: 5px 12px;
    color: var(--muted); font-family: 'DM Sans'; font-size: 12px;
    cursor: pointer; transition: border-color 0.2s, color 0.2s; white-space: nowrap;
  }
  .edit-btn:hover { border-color: var(--accent); color: var(--accent); }
  #editMembModal, #newPlayerModal, #newTournamentModal, #configModal {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.75); z-index: 1100;
    align-items: center; justify-content: center;
  }
  #editMembModal.open, #newPlayerModal.open, #newTournamentModal.open, #configModal.open { display: flex; }
  .edit-field select {
    width: 100%; box-sizing: border-box;
    background: var(--blue); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
    color: var(--text); font-family: 'DM Sans'; font-size: 14px;
  }
  .edit-field select:focus { outline: none; border-color: var(--accent); }
  .config-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .config-table th, .config-table td {
    padding: 8px 12px; text-align: center; font-size: 13px;
    border-bottom: 1px solid var(--border);
  }
  .config-table th { color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  .config-table td:first-child { text-align: left; color: var(--muted); }
  .edit-memb-box {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px; width: 400px; max-width: 92vw;
  }
  .edit-memb-title { font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 2px; margin-bottom: 4px; }
  .edit-memb-sub { font-size: 12px; color: var(--muted); margin-bottom: 24px; }
  .edit-field { margin-bottom: 16px; }
  .edit-field label {
    display: block; font-size: 11px; color: var(--muted);
    margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  .edit-field input {
    width: 100%; box-sizing: border-box;
    background: var(--blue); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px;
    color: var(--text); font-family: 'DM Sans'; font-size: 14px;
  }
  .edit-field input:focus { outline: none; border-color: var(--accent); }
  .edit-field input[readonly] { opacity: 0.5; cursor: default; }
  .edit-actions { display: flex; gap: 10px; margin-top: 8px; }
  .edit-actions .btn-primary { flex: 1; }
  .edit-memb-msg { font-size: 13px; margin-top: 14px; text-align: center; min-height: 20px; }

  /* ‚îÄ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ‚îÄ */
  .back-btn {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-family: 'DM Sans'; font-size: 14px;
    display: flex; align-items: center; gap: 8px;
    padding: 0; margin-bottom: 8px; transition: color 0.2s;
  }
  .back-btn:hover { color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .player-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .profile-hero { grid-template-columns: 1fr; }
    .overview-grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrap { max-width: 1200px; margin: 0 auto; padding: 0 32px 40px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th {
    padding: 10px 16px; text-align: left;
    font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--muted); border-bottom: 1px solid var(--border);
  }
  td {
    padding: 14px 16px; font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  tr:hover td { background: var(--card); }
  tr td:first-child { font-family: 'Bebas Neue'; font-size: 20px; color: var(--muted); }

  .scrollhint { text-align: center; color: var(--muted); font-size: 13px; margin: 24px 0; }

  /* ‚îÄ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ‚îÄ */
  #loginModal {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(10,22,40,0.96);
    backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center;
  }
  #loginModal.open { display: flex; }
  .login-box {
    background: var(--navy2);
    border: 1px solid var(--border);
    border-radius: 20px; padding: 40px;
    width: 100%; max-width: 420px; margin: 20px;
  }
  .login-box .login-header { text-align: center; margin-bottom: 32px; }
  .login-box .login-header .login-logo {
    font-family: 'Bebas Neue'; font-size: 36px; letter-spacing: 4px; color: var(--accent);
  }
  .login-box .login-header p { font-size: 13px; color: var(--muted); margin-top: 4px; }
  .login-field { margin-bottom: 16px; }
  .login-field label {
    font-size: 11px; color: var(--muted); letter-spacing: 1px;
    text-transform: uppercase; display: block; margin-bottom: 6px;
  }
  .login-field input {
    width: 100%; background: var(--navy); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 16px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
    transition: border-color 0.2s;
  }
  .login-field input:focus { border-color: var(--accent); }
  #loginError {
    color: var(--red); font-size: 13px; margin-bottom: 12px;
    display: none; text-align: center;
  }
  .btn-cancel {
    width: 100%; margin-top: 8px; background: none; border: none;
    color: var(--muted); cursor: pointer; font-family: 'DM Sans';
    font-size: 14px; padding: 8px; transition: color 0.2s;
  }
  .btn-cancel:hover { color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ TTM PR BADGE ‚îÄ‚îÄ‚îÄ */
  .ttmpr-badge {
    display: flex; flex-direction: column; align-items: center; gap: 2px;
    text-decoration: none;
    flex-shrink: 0;
  }
  .ttmpr-powered {
    font-size: 9px; letter-spacing: 0.04em;
    color: var(--text-muted, #888);
    text-transform: lowercase;
  }
  .ttmpr-logo {
    width: 120px; height: auto;
    object-fit: contain; display: block;
  }
  .header-right { display: flex; align-items: center; gap: 10px; }

  /* login/user button in header */
  .login-btn {
    background: none !important; border: 1px solid var(--border) !important;
    color: var(--text) !important; font-weight: 500 !important;
    padding: 8px 18px !important; border-radius: 8px !important;
    cursor: pointer; font-family: 'DM Sans'; font-size: 14px;
    transition: all 0.2s; white-space: nowrap;
  }
  .login-btn:hover { border-color: var(--accent) !important; color: var(--accent) !important; }
  .login-btn.signed-in {
    background: rgba(232,184,75,0.1) !important;
    border-color: rgba(232,184,75,0.3) !important;
    color: var(--accent) !important;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="fprtm-logo.jpg" alt="FPRTM Logo" class="fprtm-logo-img">
    <span class="fprtm-logo-sub">SISTEMA DE RATINGS</span>
  </div>
  <nav>
    <button id="navRankings" class="active" onclick="showPage('rankings')">üèÜ Rankings</button>
    <button id="navCalculator" onclick="showPage('calculator')">‚ö° Calcular Rating</button>
    <button id="navTorneos" onclick="showPage('torneosList')">üèì Torneos</button>
    <button id="navMembresia" style="display:none" onclick="showPage('membresia')">ü™™ Membres√≠a</button>
    <button id="navAdmin" style="display:none" onclick="showPage('admin')">‚öô Admin</button>
  </nav>
  <div class="header-right">
    <a class="ttmpr-badge" href="https://ttmpr.xyz" target="_blank" rel="noopener noreferrer">
      <span class="ttmpr-powered">powered by</span>
      <img class="ttmpr-logo" src="ttm_pr_logo_dark_transparent.png" alt="TTM PR logo">
    </a>
    <button class="login-btn" id="loginBtn" onclick="showLogin()">üîê Iniciar Sesi√≥n</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: RANKINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="rankingsPage" class="page active">
  <div class="page-hero">
    <div class="overline">Federaci√≥n Puertorrique√±a de Tenis de Mesa</div>
    <h1>RANKINGS 2026</h1>
    <p>Clasificaci√≥n nacional actualizada ¬∑ Temporada activa</p>
  </div>

  <div class="search-wrap">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Buscar jugador por nombre..." oninput="filterPlayers()">
    </div>
  </div>

  <div class="filters">
    <div class="filter-chip on" onclick="setFilter(this,'all')">Todos</div>
    <div class="filter-chip" onclick="setFilter(this,'masc')">Masculino</div>
    <div class="filter-chip" onclick="setFilter(this,'fem')">Femenino</div>
  </div>

  <div class="stats-row">
    <div class="stat-card gold">
      <div class="label">Top Rating</div>
      <div class="value" id="statTopRating">‚Äî</div>
      <div class="sub" id="statTopName">Cargando...</div>
    </div>
    <div class="stat-card">
      <div class="label">Jugadores Activos</div>
      <div class="value" id="statTotal">‚Äî</div>
      <div class="sub">En el sistema</div>
    </div>
    <div class="stat-card">
      <div class="label">Promedio Rating</div>
      <div class="value" id="statMembers">‚Äî</div>
      <div class="sub">General del ranking</div>
    </div>
    <div class="stat-card">
      <div class="label">Actualizado</div>
      <div class="value" style="font-size:24px;margin-top:6px">Feb 2026</div>
      <div class="sub">En vivo ¬∑ Supabase</div>
    </div>
  </div>

  <div class="player-grid" id="playerGrid"></div>
  <p class="scrollhint" id="loadMore" onclick="loadMorePlayers()" style="cursor:pointer;margin-top:20px;">
    ‚Üì Ver m√°s jugadores
  </p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: PLAYER PROFILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="profilePage" class="page">
  <div class="container" style="padding-bottom:0">
    <button class="back-btn" onclick="backToRankings()">‚Üê Volver a Rankings</button>
  </div>

  <div class="profile-hero">
    <div class="profile-card">
      <div class="profile-avatar" id="profileAvatar">JM</div>
      <div class="profile-name" id="profileName">Jerall Montijo</div>
      <div class="profile-id" id="profileId">ATH# ‚Äî</div>
      <div class="profile-club" id="profileClub">Naguabo</div>
      <span id="profileBadge" class="badge">Jugador activo</span>

      <div class="profile-rating-box">
        <div class="rating-label">RATING FPRTM</div>
        <div class="big-rating">
          <span style="color:var(--accent);font-size:32px">‚òÖ</span>
          <span id="profileRating">2132</span>
        </div>
        <div class="rating-label" style="margin-top:4px" id="profileCategory">Juv21U ¬∑ Masculino ¬∑ 20 a√±os</div>
      </div>

      <div class="profile-quick-stats">
        <div class="qs"><strong id="pMatches">‚Äî</strong>Partidos</div>
        <div class="qs"><strong id="pWins" style="color:var(--green)">‚Äî</strong>Victorias</div>
        <div class="qs"><strong id="pLosses" style="color:var(--red)">‚Äî</strong>Derrotas</div>
        <div class="qs"><strong id="pPct" style="color:var(--accent)">‚Äî</strong>Win %</div>
      </div>
    </div>

    <div class="profile-right">
      <div class="profile-tabs">
        <button class="ptab active" onclick="showPTab(this,'overview')">üìä Overview</button>
        <button class="ptab" onclick="showPTab(this,'torneos')">üèì Torneos</button>
        <button class="ptab" onclick="showPTab(this,'partidos')">‚ö° Partidos</button>
      </div>

      <!-- OVERVIEW TAB -->
      <div class="ptab-content active" id="tab-overview">
        <div class="overview-grid">
          <div class="ov-card">
            <div class="lbl">Ranking Nacional</div>
            <div class="val gold" id="ovRank">#2</div>
          </div>
          <div class="ov-card">
            <div class="lbl">Torneos 2026</div>
            <div class="val" id="ovTourneys">3</div>
          </div>
          <div class="ov-card">
            <div class="lbl">Pts Ganados YTD</div>
            <div class="val green" id="ovPtsYTD">+82</div>
          </div>
        </div>

        <div class="winpct-row">
          <div class="circle-wrap">
            <svg width="80" height="80" viewBox="0 0 80 80">
              <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="8"/>
              <circle cx="40" cy="40" r="34" fill="none" stroke="#e8b84b" stroke-width="8"
                stroke-dasharray="213.6" id="winCircle" stroke-dashoffset="64" stroke-linecap="round"/>
            </svg>
            <div class="circle-val" id="winPct">70%</div>
          </div>
          <div>
            <div style="font-size:15px;font-weight:600">Porcentaje de victorias (2026)</div>
            <div style="font-size:13px;color:var(--muted);margin-top:4px">Basado en torneos registrados este a√±o</div>
          </div>
        </div>

        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;">
          <div style="font-size:12px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Historial de Rating</div>
          <div style="display:flex;align-items:end;gap:6px;height:60px;">
            <!-- mini bar chart -->
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:45%;position:relative">
              <div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--muted);white-space:nowrap">Ene</div>
            </div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:60%"></div>
            <div style="flex:1;background:var(--accent);border-radius:4px 4px 0 0;height:100%">
              <div style="position:absolute;bottom:-18px;font-size:10px;color:var(--muted)"></div>
            </div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:80%"></div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:90%"></div>
          </div>
          <div style="margin-top:24px;display:flex;justify-content:space-between;font-size:11px;color:var(--muted);">
            <span>Rating Inicial 2026: <strong style="color:var(--text)" id="startRating">‚Äî</strong></span>
            <span>Rating Actual: <strong style="color:var(--accent)" id="currentRating">‚Äî</strong></span>
          </div>
        </div>
      </div>

      <!-- TORNEOS TAB -->
      <div class="ptab-content" id="tab-torneos">
        <!-- Rating progress chart (Chart.js) -->
        <div class="progress-chart-wrap" id="progressChartWrap" style="display:none">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Progresi√≥n de Rating</div>
          <canvas id="ratingProgressChart"></canvas>
        </div>
        <!-- Tournament history table -->
        <div id="tournList"></div>
      </div>

      <!-- PARTIDOS TAB -->
      <div class="ptab-content" id="tab-partidos">
        <div class="match-list" id="matchList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: CALCULADORA DE RATING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="calculatorPage" class="page">
  <div class="page-hero">
    <div class="overline">Herramienta</div>
    <h1>CALCULAR RATING</h1>
    <p>Ingresa ratings y resultados de partidos para estimar nuevos resultados</p>
  </div>

  <div class="calc-wrap">
    <div class="manual-entry">
      <h3>ENTRADA MANUAL DE PARTIDOS</h3>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">Torneo (opcional): <input id="tournName" style="background:var(--navy);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text);font-family:'DM Sans';font-size:13px;outline:none" placeholder="Ej: Clasif. Febrero 2026"></p>

      <div id="matchEntries">
        <!-- Match rows populated by JS -->
      </div>

      <button class="btn-secondary" onclick="addMatchRow()" style="margin-top:0">+ Agregar partido</button>
      <br>
      <button class="btn-primary" onclick="calculateRatings()">‚ö° Calcular Nuevos Ratings</button>

      <div class="calc-result" id="calcResult">
        <h4>RESULTADOS DEL C√ÅLCULO</h4>
        <div id="calcResultBody"></div>
        <button class="btn-primary" style="margin-top:16px" onclick="applyRatings()">‚úì Aplicar a Base de Datos</button>
        <button class="btn-secondary" onclick="document.getElementById('calcResult').classList.remove('show')">Descartar</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: SUBIR RESULTADOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="subirPage" class="page">
  <div class="page-hero">
    <div class="overline">Admin ¬∑ Torneos</div>
    <h1>SUBIR RESULTADOS</h1>
    <p>Registra el torneo y sube los partidos para actualizar los ratings oficiales</p>
  </div>

  <div class="calc-wrap">

    <!-- Paso 1: Torneo -->
    <div id="subirStep1">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <div style="background:var(--accent);color:var(--navy);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">1</div>
        <div>
          <div style="font-family:'Bebas Neue';font-size:18px;letter-spacing:2px">Datos del Torneo</div>
          <div style="font-size:12px;color:var(--muted)">Paso 1 de 2</div>
        </div>
        <div style="flex:1;height:2px;background:var(--border);margin-left:8px"></div>
        <div style="display:flex;align-items:center;gap:10px">
          <div style="background:var(--card2);color:var(--muted);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">2</div>
          <div style="font-size:12px;color:var(--muted)">Partidos</div>
        </div>
      </div>

      <div class="manual-entry">
        <h3>TORNEO</h3>
        <div class="edit-field">
          <label>Nombre del torneo *</label>
          <input type="text" id="subirTorneoNombre" placeholder="Ej: Clasificatorio Marzo 2026">
        </div>
        <div class="edit-field">
          <label>Fecha del torneo *</label>
          <input type="date" id="subirTorneoFecha">
        </div>
        <div id="subirStep1Msg" style="font-size:13px;margin-top:8px"></div>
        <button class="btn-primary" onclick="subirPaso2()" style="margin-top:20px">Continuar ‚Üí Subir Partidos</button>
      </div>
    </div>

    <!-- Paso 2: CSV + Resultados -->
    <div id="subirStep2" style="display:none">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <div style="background:var(--card2);color:var(--muted);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">1</div>
        <div style="font-size:12px;color:var(--muted)">Torneo</div>
        <div style="flex:1;height:2px;background:var(--accent);margin:0 8px"></div>
        <div style="background:var(--accent);color:var(--navy);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;flex-shrink:0">2</div>
        <div>
          <div style="font-family:'Bebas Neue';font-size:18px;letter-spacing:2px">Partidos</div>
          <div style="font-size:12px;color:var(--muted)">Paso 2 de 2</div>
        </div>
      </div>

      <!-- Torneo info badge -->
      <div id="subirTorneoInfo" style="background:rgba(232,184,75,0.08);border:1px solid rgba(232,184,75,0.25);border-radius:10px;padding:12px 16px;margin-bottom:20px;font-size:14px">
      </div>

      <div class="manual-entry">
        <h3>PARTIDOS DEL TORNEO</h3>

        <!-- CSV drop area -->
        <div class="csv-drop-area" id="subirDropArea"
             onclick="document.getElementById('subirFileInput').click()"
             ondragover="event.preventDefault();this.classList.add('drag-over')"
             ondragleave="this.classList.remove('drag-over')"
             ondrop="subirHandleDrop(event)">
          <div class="upload-icon">üìÇ</div>
          <div class="upload-label" id="subirDropLabel">Arrastra tu CSV aqu√≠ o haz clic para seleccionar</div>
          <div class="upload-hint">Formato: Jugador A, Jugador B, Ganador (A o B)</div>
          <input type="file" id="subirFileInput" accept=".csv,.txt" style="display:none" onchange="subirHandleFile(event)">
        </div>

        <div id="subirCsvStatus" style="display:none;margin-top:12px;padding:10px 14px;border-radius:8px;font-size:13px"></div>

        <!-- Format reference -->
        <div style="margin-top:16px;padding:14px;background:var(--navy);border:1px solid var(--border);border-radius:8px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Formato del CSV</div>
          <code style="display:block;font-family:'DM Mono';font-size:12px;background:rgba(0,0,0,0.3);padding:8px 10px;border-radius:6px;color:var(--accent);white-space:pre">Jugador A,Jugador B,Ganador
Juan Garc√≠a,Pedro Rodr√≠guez,A
Maria Lopez,Ana Torres,B</code>
          <button class="btn-secondary" style="padding:7px 14px;font-size:12px;margin-top:10px;margin-left:0" onclick="downloadCsvTemplate()">‚¨á Descargar plantilla</button>
        </div>

        <button class="btn-primary" id="subirProcesarBtn" onclick="subirProcesarCsv()" style="display:none;margin-top:20px">‚ö° Calcular cambios de rating</button>
      </div>

      <!-- Results preview -->
      <div class="calc-result" id="subirResult">
        <h4>RESULTADOS A APLICAR</h4>
        <div id="subirResultBody"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn-primary" id="subirApplyBtn" onclick="subirApplyRatings()">‚úì Confirmar y Aplicar a Base de Datos</button>
          <button class="btn-secondary" onclick="document.getElementById('subirResult').classList.remove('show')">Recalcular</button>
        </div>
      </div>

      <div style="margin-top:16px">
        <button class="btn-secondary" style="margin-left:0" onclick="subirBack()">‚Üê Volver al Torneo</button>
      </div>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: TORNEOS LIST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="torneosListPage" class="page">
  <div class="page-hero">
    <div class="overline">Historial</div>
    <h1>TORNEOS</h1>
    <p>Selecciona un torneo para ver el Rating Summary del evento</p>
  </div>
  <div class="torneos-grid" id="torneosGrid">
    <div style="text-align:center;padding:40px;color:var(--muted)">Cargando torneos...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: TORNEO EVENTO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="torneoEventoPage" class="page">
  <div class="page-hero">
    <div class="overline" id="eventoOverline">Torneo</div>
    <h1 id="eventoTitle">‚Äî</h1>
    <p id="eventoSubtitle"></p>
  </div>

  <div class="evento-header">
    <button class="btn-secondary" style="margin:0;padding:8px 16px;font-size:13px" onclick="showPage('torneosList')">‚Üê Volver a Torneos</button>
    <div style="display:flex;gap:12px;align-items:center">
      <div id="eventoStatBadge" style="background:rgba(232,184,75,0.1);border:1px solid rgba(232,184,75,0.3);border-radius:8px;padding:8px 16px;text-align:center">
        <div style="font-family:'DM Mono';font-size:22px;font-weight:700;color:var(--accent)" id="eventoParticipantCount">‚Äî</div>
        <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">Participantes</div>
      </div>
    </div>
  </div>

  <div class="evento-search-wrap">
    <input id="eventoSearchInput" type="text" placeholder="üîç Buscar participante..." oninput="filterEventoRows()">
  </div>

  <div class="evento-grid" id="eventoGrid">
    <div style="text-align:center;padding:40px;color:var(--muted)">Cargando resultados...</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: MEMBRES√çA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="membresia_page" class="page">
  <div class="page-hero">
    <div class="overline">Gesti√≥n</div>
    <h1>MEMBRES√çA 2026</h1>
    <p>Control de miembros activos, vencidos y alertas</p>
  </div>

  <div class="alert-banner">
    <div class="alert-box">
      <span class="icon">‚ö†Ô∏è</span>
      <div id="alertText">Cargando estado de membres√≠as...</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card gold">
      <div class="label">Miembros Activos</div>
      <div class="value" id="membActive">‚Äî</div>
      <div class="sub">Temporada 2026</div>
    </div>
    <div class="stat-card">
      <div class="label">Sin Membres√≠a</div>
      <div class="value" style="color:var(--red)" id="membNo">‚Äî</div>
      <div class="sub">En ranking pero no miembros</div>
    </div>
    <div class="stat-card">
      <div class="label">Nuevos (Feb)</div>
      <div class="value" style="color:var(--green)" id="membNew">‚Äî</div>
      <div class="sub">Registrados este mes</div>
    </div>
    <div class="stat-card">
      <div class="label">Por Vencer</div>
      <div class="value" style="color:var(--orange)" id="membWarn">‚Äî</div>
      <div class="sub">Pr√≥ximos 30 d√≠as</div>
    </div>
  </div>

  <div class="memb-search-wrap">
    <input id="membSearchInput" type="text" placeholder="üîç Buscar jugador por nombre..." oninput="renderMembers()">
  </div>

  <div class="filters" style="margin-bottom:16px">
    <div class="filter-chip on" onclick="setMembFilter(this,'all')">Todos</div>
    <div class="filter-chip" onclick="setMembFilter(this,'active')">‚úÖ Activos</div>
    <div class="filter-chip" onclick="setMembFilter(this,'warning')">‚ö†Ô∏è Por Vencer</div>
    <div class="filter-chip" onclick="setMembFilter(this,'no')">‚ùå Sin Membres√≠a</div>
  </div>

  <div class="memb-grid" id="membGrid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: ADMIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="adminPage" class="page">
  <div class="page-hero">
    <div class="overline">Panel Administrativo</div>
    <h1>ADMIN FPRTM</h1>
    <p>Gesti√≥n de base de datos, torneos y configuraci√≥n</p>
  </div>
  <div class="container">
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showPage('subir')">
        <div style="font-size:32px;margin-bottom:12px">üì∏</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Subir Resultados</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">CSV de partidos ‚Üí actualizar ratings oficiales</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="exportRankings()">
        <div style="font-size:32px;margin-bottom:12px">üìä</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Exportar Rankings</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Descargar Excel actualizado</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showPage('membresia')">
        <div style="font-size:32px;margin-bottom:12px">ü™™</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Gestionar Membres√≠as</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Activar, vencer, alertas</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showNewPlayerModal()">
        <div style="font-size:32px;margin-bottom:12px">‚ûï</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Nuevo Jugador</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Registrar jugador en el sistema</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showNewTournamentModal()">
        <div style="font-size:32px;margin-bottom:12px">üèì</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Crear Torneo</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Nuevo evento en calendario</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showConfigModal()">
        <div style="font-size:32px;margin-bottom:12px">‚öô</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Configuraci√≥n</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Tabla de puntos, categor√≠as</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EDIT MEMBER MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="editMembModal">
  <div class="edit-memb-box">
    <div class="edit-memb-title">Editar Miembro</div>
    <div class="edit-memb-sub" id="editMembSub">FPRTM #‚Äî</div>
    <input type="hidden" id="editMembId">
    <div class="edit-field">
      <label>Nombre</label>
      <input type="text" id="editMembName" readonly>
    </div>
    <div class="edit-field">
      <label>Email</label>
      <input type="email" id="editMembEmail" placeholder="correo@ejemplo.com">
    </div>
    <div class="edit-field">
      <label>Club</label>
      <input type="text" id="editMembClub" placeholder="Nombre del club">
    </div>
    <div class="edit-field">
      <label>Fecha de Vencimiento</label>
      <input type="date" id="editMembExpDate">
    </div>
    <div class="edit-field">
      <label>Rating</label>
      <input type="number" id="editMembRating" min="100" max="3000" step="1" placeholder="1500">
    </div>
    <div id="editMembMsg" class="edit-memb-msg"></div>
    <div class="edit-actions">
      <button class="btn-cancel" onclick="closeEditMember()">Cancelar</button>
      <button class="btn-primary" id="editMembSaveBtn" onclick="saveEditMember()">Guardar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     NUEVO JUGADOR MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="newPlayerModal">
  <div class="edit-memb-box">
    <div class="edit-memb-title">Nuevo Jugador</div>
    <div class="edit-memb-sub">Registrar jugador en la base de datos</div>
    <div class="edit-field">
      <label>Nombre</label>
      <input type="text" id="newPlayerFirstName" placeholder="Ej: Juan">
    </div>
    <div class="edit-field">
      <label>Apellido</label>
      <input type="text" id="newPlayerLastName" placeholder="Ej: Garc√≠a">
    </div>
    <div class="edit-field">
      <label>Sexo</label>
      <select id="newPlayerSex">
        <option value="">‚Äî Sin especificar ‚Äî</option>
        <option value="M">Masculino</option>
        <option value="F">Femenino</option>
      </select>
    </div>
    <div class="edit-field">
      <label>Club</label>
      <input type="text" id="newPlayerClub" placeholder="Nombre del club">
    </div>
    <div class="edit-field">
      <label>Rating Inicial</label>
      <input type="number" id="newPlayerRating" min="100" max="3000" step="1" placeholder="1500" value="1500">
    </div>
    <div class="edit-field">
      <label>Email</label>
      <input type="email" id="newPlayerEmail" placeholder="correo@ejemplo.com">
    </div>
    <div class="edit-field">
      <label>Fecha de Vencimiento de Membres√≠a</label>
      <input type="date" id="newPlayerExpDate">
    </div>
    <div id="newPlayerMsg" class="edit-memb-msg"></div>
    <div class="edit-actions">
      <button class="btn-cancel" onclick="hideNewPlayerModal()">Cancelar</button>
      <button class="btn-primary" id="newPlayerSaveBtn" onclick="saveNewPlayer()">Crear Jugador</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CREAR TORNEO MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="newTournamentModal">
  <div class="edit-memb-box">
    <div class="edit-memb-title">Crear Torneo</div>
    <div class="edit-memb-sub">Registrar nuevo evento en el calendario</div>
    <div class="edit-field">
      <label>Nombre del Torneo</label>
      <input type="text" id="newTournamentName" placeholder="Ej: Clasificatorio Marzo 2026">
    </div>
    <div class="edit-field">
      <label>Fecha</label>
      <input type="date" id="newTournamentDate">
    </div>
    <div id="newTournamentMsg" class="edit-memb-msg"></div>
    <div class="edit-actions">
      <button class="btn-cancel" onclick="hideNewTournamentModal()">Cancelar</button>
      <button class="btn-primary" id="newTournamentSaveBtn" onclick="saveNewTournament()">Crear Torneo</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EDITAR TORNEO MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="editTorneoModal">
  <div class="edit-memb-box">
    <div class="edit-memb-title">Editar Torneo</div>
    <div class="edit-memb-sub" id="editTorneoSub">Actualizar nombre y fecha</div>
    <input type="hidden" id="editTorneoId">
    <div class="edit-field">
      <label>Nombre del Torneo</label>
      <input type="text" id="editTorneoName" placeholder="Nombre del torneo">
    </div>
    <div class="edit-field">
      <label>Fecha</label>
      <input type="date" id="editTorneoDate">
    </div>
    <div id="editTorneoMsg" class="edit-memb-msg"></div>
    <div class="edit-actions">
      <button class="btn-cancel" onclick="hideEditTorneoModal()">Cancelar</button>
      <button class="btn-primary" id="editTorneoSaveBtn" onclick="saveEditTorneo()">Guardar Cambios</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CONFIRMAR BORRADO TORNEO MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="deleteTorneoModal">
  <div class="edit-memb-box" style="text-align:center;max-width:420px">
    <div style="font-size:40px;margin-bottom:8px">‚ö†Ô∏è</div>
    <div class="edit-memb-title" style="color:var(--red)">Borrar Torneo</div>
    <div class="edit-memb-sub" id="deleteTorneoNameLabel" style="font-size:15px;font-weight:600;color:var(--text)"></div>
    <div style="color:var(--muted);font-size:13px;line-height:1.6;margin:14px 0">
      Esta acci√≥n <strong style="color:var(--text)">revertir√° los ratings</strong> de todos los jugadores
      que participaron y eliminar√° todos los partidos y resultados asociados.<br>
      <strong style="color:var(--red)">No se puede deshacer.</strong>
    </div>
    <input type="hidden" id="deleteTorneoId">
    <div id="deleteTorneoMsg" class="edit-memb-msg"></div>
    <div class="edit-actions" style="justify-content:center;gap:12px">
      <button class="btn-cancel" id="deleteTorneoCancelBtn" onclick="hideDeleteTorneoModal()">Cancelar</button>
      <button class="btn-primary" id="deleteTorneoConfirmBtn"
        style="background:var(--red);border-color:var(--red);color:#fff"
        onclick="eliminarTorneo()">S√≠, Borrar y Revertir</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CONFIGURACI√ìN MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="configModal">
  <div class="edit-memb-box" style="width:480px">
    <div class="edit-memb-title">Configuraci√≥n</div>
    <div class="edit-memb-sub">Tabla de puntos del sistema de ratings FPRTM</div>
    <table class="config-table">
      <thead>
        <tr>
          <th>Diferencia de Rating</th>
          <th>Favorito gana</th>
          <th>Underdog gana</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>0 ‚Äì 24 pts</td><td style="color:var(--accent)">+8</td><td style="color:var(--accent)">+8</td></tr>
        <tr><td>25 ‚Äì 49 pts</td><td style="color:var(--green)">+7</td><td style="color:var(--accent)">+10</td></tr>
        <tr><td>50 ‚Äì 99 pts</td><td style="color:var(--green)">+5</td><td style="color:var(--accent)">+12</td></tr>
        <tr><td>100 ‚Äì 149 pts</td><td style="color:var(--green)">+3</td><td style="color:var(--accent)">+15</td></tr>
        <tr><td>150 ‚Äì 199 pts</td><td style="color:var(--green)">+2</td><td style="color:var(--accent)">+20</td></tr>
        <tr><td>200 ‚Äì 249 pts</td><td style="color:var(--green)">+1</td><td style="color:var(--accent)">+26</td></tr>
        <tr><td>250+ pts</td><td style="color:var(--muted)">+0</td><td style="color:var(--accent)">+32</td></tr>
      </tbody>
    </table>
    <div style="font-size:12px;color:var(--muted);margin-top:16px">El perdedor pierde la misma cantidad de puntos que gana el ganador.</div>
    <div class="edit-actions" style="margin-top:24px">
      <button class="btn-primary" onclick="hideConfigModal()">Cerrar</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginModal">
  <div class="login-box">
    <div class="login-header">
      <div class="login-logo">FPRTM</div>
      <p>Acceso al panel administrativo</p>
    </div>
    <div class="login-field">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="admin@fprtm.com"
        onkeydown="if(event.key==='Enter')signIn()">
    </div>
    <div class="login-field" style="margin-bottom:24px">
      <label>Contrase√±a</label>
      <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        onkeydown="if(event.key==='Enter')signIn()">
    </div>
    <div id="loginError"></div>
    <button id="loginSubmitBtn" class="btn-primary" style="width:100%;margin-top:0" onclick="signIn()">Entrar</button>
    <button class="btn-cancel" onclick="hideLogin()">Cancelar</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://qrvyfdpwtearfpjruwja.supabase.co';
const SUPABASE_KEY = 'sb_publishable_mM59efPqpcgrR3g3_6F_Ww_h1jg4PyV';

// Auth client (supabase-js v2)
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;

// Returns true only for users with app_metadata.is_admin = true
// (set in Supabase Dashboard ‚Üí Authentication ‚Üí Users ‚Üí Edit ‚Üí app_metadata)
function isAdmin() {
  return currentUser?.app_metadata?.is_admin === true;
}

const SB_HEADERS = {
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Content-Type': 'application/json'
};

async function sbGet(table, params = '') {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${params}`, { headers: SB_HEADERS });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase GET ${table} (${res.status}): ${err}`);
  }
  return res.json();
}

async function sbPatch(table, query, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    method: 'PATCH',
    headers: { ...SB_HEADERS, 'Prefer': 'return=minimal' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase PATCH ${table} (${res.status}): ${err}`);
  }
}

async function sbDelete(table, query) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    method: 'DELETE',
    headers: { ...SB_HEADERS, 'Prefer': 'return=minimal' }
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase DELETE ${table} (${res.status}): ${err}`);
  }
}

async function sbPost(table, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: { ...SB_HEADERS, 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase POST ${table} (${res.status}): ${err}`);
  }
  return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAuthUI() {
  const isLoggedIn = !!currentUser;
  const el_memb  = document.getElementById('navMembresia');
  const el_admin = document.getElementById('navAdmin');
  if (el_memb)  el_memb.style.display  = isLoggedIn ? '' : 'none';
  if (el_admin) el_admin.style.display = isAdmin()   ? '' : 'none';
  const btn = document.getElementById('loginBtn');
  if (!btn) return;
  if (isLoggedIn) {
    btn.textContent = 'üë§ ' + currentUser.email.split('@')[0] + ' ¬∑ Salir';
    btn.classList.add('signed-in');
    btn.onclick = signOut;
  } else {
    btn.textContent = 'üîê Iniciar Sesi√≥n';
    btn.classList.remove('signed-in');
    btn.onclick = showLogin;
  }
}

function showLogin() {
  document.getElementById('loginModal').classList.add('open');
  setTimeout(() => document.getElementById('loginEmail').focus(), 100);
}

function hideLogin() {
  document.getElementById('loginModal').classList.remove('open');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
}

async function signIn() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl    = document.getElementById('loginError');
  const btn      = document.getElementById('loginSubmitBtn');

  errEl.style.display = 'none';
  if (!email || !password) {
    errEl.textContent = 'Ingresa email y contrase√±a.';
    errEl.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Verificando...';

  const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

  btn.disabled = false;
  btn.textContent = 'Entrar';

  if (error) {
    errEl.textContent = 'Credenciales incorrectas. Intenta de nuevo.';
    errEl.style.display = 'block';
    return;
  }

  currentUser = data.user;
  updateAuthUI();
  hideLogin();
}

async function signOut() {
  await _supabase.auth.signOut();
  currentUser = null;
  updateAuthUI();
  showPage('rankings');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA (live from Supabase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ALL_PLAYERS = []; // full list with correct national ranks
let RANK_BY_ID  = {}; // { player_id: rank } lookup from full list
let PLAYERS = [];
let MEMBERS = [];
// Cache player lookup by name for calculator autocomplete fill
let PLAYER_BY_NAME = {};

function showLoading(show) {
  let el = document.getElementById('loadingOverlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loadingOverlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(10,22,40,0.9);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px';
    el.innerHTML = `
      <div style="width:48px;height:48px;border:3px solid rgba(232,184,75,0.2);border-top-color:#e8b84b;border-radius:50%;animation:spin 0.8s linear infinite"></div>
      <div style="font-family:Bebas Neue;font-size:20px;letter-spacing:3px;color:#e8b84b">CARGANDO...</div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>`;
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

function showError(msg) {
  document.getElementById('playerGrid').innerHTML = `
    <div style="grid-column:1/-1;text-align:center;padding:40px 20px">
      <div style="font-size:36px;margin-bottom:12px">‚ö†Ô∏è</div>
      <div style="color:var(--red);font-family:'Bebas Neue';font-size:22px;letter-spacing:2px">Error de Conexi√≥n</div>
      <div style="color:var(--muted);font-size:13px;margin-top:8px;max-width:400px;margin-left:auto;margin-right:auto">${msg}</div>
      <button onclick="location.reload()" class="btn-primary" style="margin-top:16px;font-size:13px;padding:8px 20px">‚Ü∫ Reintentar</button>
    </div>`;
}

async function loadPlayers(filter = {}) {
  // Only fetch non-sensitive columns ‚Äî never request Email, Home Address, or Date of Birth
  let params = '?select=%22Member%20ID%22,%22First%20Name%22,%22Last%20Name%22,%22Rating%22,%22Sex%22,%22Club%22,%22Expiration%20Date%22&order=Rating.desc&limit=600';
  if (filter.sexoAny?.length) {
    const sexoOr = filter.sexoAny
      .map(v => `Sex.eq.${encodeURIComponent(v)}`)
      .join(',');
    params += `&or=(${sexoOr})`;
  } else if (filter.sexo) {
    params += `&Sex=eq.${encodeURIComponent(filter.sexo)}`;
  }

  const data = await sbGet('Base%20de%20Datos', params);
  const now = new Date();
  return data.map((p, i) => ({
    id: p['Member ID'],
    rank: i + 1,
    name: `${p['First Name'] || ''} ${p['Last Name'] || ''}`.trim(),
    sex: p['Sex'] || '',
    gender: p['Sex'] || '',
    age: null,
    cat: null,
    club: p['Club'],
    member: p['Expiration Date'] ? new Date(p['Expiration Date']) > now : false,
    rating: p['Rating'],
    ratingStart: p['Rating']
  }));
}

async function loadMembers() {
  // Only fetch non-sensitive columns ‚Äî never request Home Address or Date of Birth
  const data = await sbGet('Base%20de%20Datos', '?select=%22Member%20ID%22,%22First%20Name%22,%22Last%20Name%22,%22Club%22,%22Sex%22,%22Email%22,%22Expiration%20Date%22&order=%22Member%20ID%22.asc&limit=300');
  const now = new Date();
  return data.map(m => {
    const expDate = m['Expiration Date'] ? new Date(m['Expiration Date']) : null;

    let status = 'no';
    let daysUntilExp = null;
    if (expDate) {
      daysUntilExp = Math.floor((expDate.getTime() - now.getTime()) / 86400000);
      if (daysUntilExp < 0)        status = 'expired';
      else if (daysUntilExp <= 30) status = 'warning';
      else                          status = 'active';
    }

    return {
      id:          m['Member ID'],
      name:        `${m['First Name'] || ''} ${m['Last Name'] || ''}`.trim(),
      club:        m['Club'] || '‚Äî',
      sex:         m['Sex'] || '‚Äî',
      age:         '‚Äî',
      date:        '‚Äî',
      expDate:     expDate ? expDate.toISOString().split('T')[0] : '‚Äî',
      daysUntilExp,
      status,
      email:       m['Email'] || '',
      tel:         '',
      pueblo:      '',
      ath:         m['Member ID'] ? '***' : ''
    };
  });
}

function updateStats() {
  const top = PLAYERS[0] || {};
  document.getElementById('statTopRating').textContent = top.rating || '‚Äî';
  document.getElementById('statTopName').textContent   = top.name
    ? top.name.split(' ').slice(0, 2).join(' ') : '‚Äî';
  document.getElementById('statTotal').textContent   = PLAYERS.length;
  const avgRating = PLAYERS.length ? Math.round(PLAYERS.reduce((acc, p) => acc + (Number(p.rating) || 0), 0) / PLAYERS.length) : 0;
  document.getElementById('statMembers').textContent = avgRating || '‚Äî';

  // Membres√≠a page stats
  const active  = MEMBERS.filter(m => m.status === 'active').length;
  const warning = MEMBERS.filter(m => m.status === 'warning').length;
  const noMember = PLAYERS.filter(p => !p.member).length;
  const thisMonth = MEMBERS.filter(m => {
    if (!m.date || m.date === '‚Äî') return false;
    const d = new Date(m.date);
    const now = new Date();
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  }).length;

  const els = {
    membActive: active + warning,
    membNo: noMember,
    membNew: thisMonth,
    membWarn: warning
  };
  Object.entries(els).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  });

  // Alert banner
  const alertEl = document.getElementById('alertText');
  if (alertEl) {
    if (warning > 0) {
      alertEl.innerHTML = `<strong>${warning} membres√≠a${warning>1?'s':''} pr√≥xima${warning>1?'s':''} a vencer</strong> en los pr√≥ximos 30 d√≠as. <span style="color:var(--muted)"> ¬∑ ${noMember} jugadores sin membres√≠a activa.</span>`;
    } else {
      alertEl.innerHTML = `<strong style="color:var(--green)">‚úì Todas las membres√≠as est√°n al d√≠a.</strong> <span style="color:var(--muted)">${noMember} jugadores sin membres√≠a.</span>`;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pages = {
  rankings:      'rankingsPage',
  calculator:    'calculatorPage',
  subir:         'subirPage',
  torneosList:   'torneosListPage',
  torneoEvento:  'torneoEventoPage',
  membresia:     'membresia_page',
  admin:         'adminPage',
  profile:       'profilePage'
};

function showPage(key) {
  const PROTECTED = ['membresia', 'admin', 'subir'];
  if (PROTECTED.includes(key) && !currentUser) {
    showLogin();
    return;
  }

  Object.values(pages).forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.classList.remove('active'); el.style.display = 'none'; }
  });
  const target = document.getElementById(pages[key]);
  if (target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); }

  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const navMap = { rankings: 0, calculator: 1, torneosList: 2, torneoEvento: 2, membresia: 3, admin: 4 };
  if (navMap[key] !== undefined) document.querySelectorAll('nav button')[navMap[key]]?.classList.add('active');

  // Reset subir page to step 1 every time it's opened
  if (key === 'subir') {
    document.getElementById('subirStep1').style.display = '';
    document.getElementById('subirStep2').style.display = 'none';
    document.getElementById('subirStep1Msg').textContent = '';
    document.getElementById('subirTorneoFecha').value = new Date().toISOString().split('T')[0];
  }
  // Load torneos list on navigation
  if (key === 'torneosList') loadTorneosList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RANKINGS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentFilter = 'all';
let displayedCount = 0;
const PAGE_SIZE = 20;

function initials(name) {
  if (!name || name === '‚Äî') return '??';
  return name.split(' ').slice(0, 2).map(w => w[0] || '').join('').toUpperCase();
}


function sexGroup(value) {
  const v = String(value || '').trim().toLowerCase();
  if (!v) return '';
  // femenino checked first to prevent 'female'.includes('male') false positive
  if (v === 'f' || v === 'femenino' || v === 'female' || v.includes('femenino') || v.includes('female')) return 'fem';
  if (v === 'm' || v === 'masculino' || v === 'male' || v.includes('masculino')) return 'masc';
  return '';
}

function playerSexGroup(player) {
  return (
    sexGroup(player?.sex) ||
    sexGroup(player?.gender) ||
    sexGroup(player?.cat) ||
    ''
  );
}

function renderPlayers(list, append = false) {
  const grid = document.getElementById('playerGrid');
  if (!append) grid.innerHTML = '';

  if (!list.length && !append) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">No se encontraron jugadores con este filtro.</div>';
    return;
  }

  list.forEach(p => {
    const card = document.createElement('div');
    card.className = 'player-card';
    card.onclick = () => showProfile(p);
    card.innerHTML = `
      <div class="avatar-wrap"><div class="avatar">${initials(p.name)}</div></div>
      <div class="player-info">
        <div class="rank-num ${p.rank <= 3 ? 'top3' : ''}">#${p.rank}</div>
        <div class="player-name">${p.name}</div>
        <div class="player-meta">${p.cat || '‚Äî'} ¬∑ ${p.club || 'Sin club'} ¬∑ ${p.sex || '‚Äî'}</div>
      </div>
      <div class="player-right">
        <div class="rating-num"><span class="star">‚òÖ</span>${p.rating}</div>
        <div class="player-stats">${p.age ? p.age + ' a√±os' : '‚Äî'}</div>
      </div>`;
    grid.appendChild(card);
  });
}

function loadMorePlayers() {
  const next = PLAYERS.slice(displayedCount, displayedCount + PAGE_SIZE);
  renderPlayers(next, true);
  displayedCount += next.length;
  if (displayedCount >= PLAYERS.length) document.getElementById('loadMore').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER PROFILE ‚Äî real data from DB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showProfile(player) {
  // Reset tabs to overview
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.ptab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.ptab')[0].classList.add('active');
  document.getElementById('tab-overview').classList.add('active');

  // Basic info
  document.getElementById('profileAvatar').textContent = initials(player.name);
  document.getElementById('profileName').textContent   = player.name;
  document.getElementById('profileId').textContent     = 'FPRTM #' + String(player.rank).padStart(4, '0');
  document.getElementById('profileClub').textContent   = player.club || 'Sin club';
  const _badge = document.getElementById('profileBadge');
  _badge.className = 'badge';
  _badge.style.display = 'none';
  document.getElementById('profileRating').textContent = player.rating;
  document.getElementById('profileCategory').textContent =
    [player.cat, player.sex, player.age ? player.age + ' a√±os' : ''].filter(Boolean).join(' ¬∑ ');
  document.getElementById('ovRank').textContent        = '#' + player.rank;
  document.getElementById('startRating').textContent   = player.ratingStart || player.rating;
  document.getElementById('currentRating').textContent = player.rating;

  const ytd = player.rating - (player.ratingStart || player.rating);
  document.getElementById('ovPtsYTD').textContent = (ytd >= 0 ? '+' : '') + ytd;

  showPage('profile');

  // Loading placeholders
  document.getElementById('pMatches').textContent      = '‚Ä¶';
  document.getElementById('pWins').textContent         = '‚Ä¶';
  document.getElementById('pLosses').textContent       = '‚Ä¶';
  document.getElementById('pPct').textContent          = '‚Ä¶';
  document.getElementById('ovTourneys').textContent    = '‚Ä¶';
  document.getElementById('tournList').innerHTML       = '<div style="color:var(--muted);padding:20px">Cargando historial...</div>';
  document.getElementById('matchList').innerHTML       = '<div style="color:var(--muted);padding:20px">Cargando partidos...</div>';

  // ‚îÄ‚îÄ Parallel queries ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const [partidosRes, participacionesRes] = await Promise.allSettled([
    sbGet('partidos', `?or=(jugador_a_id.eq.${player.id},jugador_b_id.eq.${player.id})&order=fecha.desc&limit=50`),
    sbGet('resultados_evento', `?id_jugador=eq.${player.id}&order=created_at.asc&limit=100`)
  ]);

  // ‚îÄ‚îÄ MATCH STATS (from partidos) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (partidosRes.status === 'fulfilled') {
    const matches = partidosRes.value;
    let wins = 0, losses = 0;
    matches.forEach(m => {
      const won = m.ganador === (m.jugador_a_id === player.id ? 'A' : 'B');
      if (won) wins++; else losses++;
    });

    const total = wins + losses;
    const pct   = total > 0 ? Math.round(wins / total * 100) : 0;
    document.getElementById('pMatches').textContent = total;
    document.getElementById('pWins').textContent    = wins;
    document.getElementById('pLosses').textContent  = losses;
    document.getElementById('pPct').textContent     = pct + '%';
    document.getElementById('winPct').textContent   = pct + '%';
    document.getElementById('winCircle').style.strokeDashoffset = 213.6 * (1 - pct / 100);

    // Render match list
    const ml = document.getElementById('matchList');
    if (matches.length) {
      ml.innerHTML = matches.slice(0, 20).map(m => {
        const isA       = m.jugador_a_id === player.id;
        const myRating  = isA ? m.rating_a_antes   : m.rating_b_antes;
        const myAfter   = isA ? m.rating_a_despues  : m.rating_b_despues;
        const oppName   = isA ? (m.nombre_b || `#${m.jugador_b_id}`) : (m.nombre_a || `#${m.jugador_a_id}`);
        const oppRating = isA ? m.rating_b_antes    : m.rating_a_antes;
        const pts       = (myAfter || myRating) - (myRating || 0);
        const won       = m.ganador === (isA ? 'A' : 'B');
        return `<div class="match-item">
          <div class="match-player ${won ? 'winner' : 'loser'}">
            <div class="name">${won ? 'üëë ' : ''}${player.name.split(' ')[0]}</div>
            <div class="rating-tag">‚òÖ ${myRating || '‚Äî'}</div>
            ${myAfter ? `<div class="pts-change">${pts >= 0 ? '+' : ''}${pts} pts</div>` : ''}
          </div>
          <div class="match-center">
            <div class="match-score">${m.resultado || 'VS'}</div>
            <div class="match-date">${m.fecha ? new Date(m.fecha).toLocaleDateString('es-PR',{month:'short',day:'numeric'}) : ''}</div>
          </div>
          <div class="match-player ${!won ? 'winner' : 'loser'} right">
            <div class="name">${!won ? 'üëë ' : ''}${oppName.split(' ')[0]}</div>
            <div class="rating-tag">‚òÖ ${oppRating || '‚Äî'}</div>
          </div>
        </div>`;
      }).join('');
    } else {
      ml.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">Sin partidos registrados a√∫n.</div>';
    }
  } else {
    ['pMatches','pWins','pLosses','pPct'].forEach(id => document.getElementById(id).textContent = '‚Äî');
    document.getElementById('matchList').innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">Sin partidos registrados a√∫n.</div>';
  }

  // ‚îÄ‚îÄ TOURNAMENT HISTORY (from resultados_evento) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (participacionesRes.status === 'fulfilled' && participacionesRes.value.length) {
    const parts = participacionesRes.value;
    document.getElementById('ovTourneys').textContent = parts.length;

    // Fetch torneo metadata (name + date) for each unique torneo
    let torneoMeta = {};
    try {
      const ids = [...new Set(parts.map(p => p.id_torneo))];
      const torneos = await sbGet('torneos', `?id=in.(${ids.join(',')})&select=id,nombre,fecha`);
      torneos.forEach(t => { torneoMeta[t.id] = { nombre: t.nombre, fecha: t.fecha }; });
    } catch(_) {}

    renderTournamentHistory(parts, torneoMeta);
    updateProgressChart(parts, torneoMeta);
  } else {
    document.getElementById('ovTourneys').textContent = 0;
    document.getElementById('tournList').innerHTML =
      '<div style="color:var(--muted);padding:20px;text-align:center">Sin torneos registrados a√∫n.</div>';
    document.getElementById('progressChartWrap').style.display = 'none';
  }
}

function renderTournamentHistory(parts, torneoMeta) {
  const tl = document.getElementById('tournList');
  if (!parts.length) {
    tl.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">Sin torneos registrados a√∫n.</div>';
    return;
  }

  // Sort newest-first for display
  const sorted = [...parts].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

  tl.innerHTML = `
    <table class="hist-table">
      <thead>
        <tr>
          <th>Torneo</th>
          <th>R√©cord</th>
          <th>Cambio (Œî)</th>
          <th>Rating Post</th>
        </tr>
      </thead>
      <tbody>
        ${sorted.map(p => {
          const meta   = torneoMeta[p.id_torneo] || {};
          const nombre = meta.nombre || `Torneo #${p.id_torneo}`;
          const fecha  = meta.fecha
            ? new Date(meta.fecha + 'T12:00:00').toLocaleDateString('es-PR', { month:'short', year:'numeric' })
            : '';
          const delta      = p.rating_fin - p.rating_inicio;
          const deltaClass = delta > 0 ? 'gain' : delta < 0 ? 'loss' : 'tie';
          const deltaText  = delta > 0 ? `‚ñ≤ +${delta}` : delta < 0 ? `‚ñº ${delta}` : `= 0`;
          const safeNombre = nombre.replace(/'/g, "\\'");
          return `<tr>
            <td>
              <div class="hist-t-name" onclick="openTorneoEvento(${p.id_torneo},'${safeNombre}','${meta.fecha || ''}')">${nombre}</div>
              <div style="font-size:11px;color:var(--muted)">${fecha}</div>
            </td>
            <td>
              <div class="hist-wl">
                <span class="wl-chip w">${p.ganados}W</span>
                <span class="wl-chip l">${p.perdidos}L</span>
              </div>
            </td>
            <td><span class="hist-delta ${deltaClass}">${deltaText}</span></td>
            <td><span class="hist-rating-post">${p.rating_fin}</span></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

let _profileChart = null;

function updateProgressChart(parts, torneoMeta) {
  const wrap = document.getElementById('progressChartWrap');
  const canvas = document.getElementById('ratingProgressChart');
  if (!wrap || !canvas) return;

  // Sort chronologically for the chart
  const sorted = [...parts].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

  if (sorted.length < 2) { wrap.style.display = 'none'; return; }
  wrap.style.display = '';

  const labels = sorted.map(p => torneoMeta[p.id_torneo]?.nombre || `T#${p.id_torneo}`);
  const data   = sorted.map(p => p.rating_fin);

  if (_profileChart) { _profileChart.destroy(); _profileChart = null; }

  _profileChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data,
        borderColor: '#e8b84b',
        backgroundColor: 'rgba(232,184,75,0.08)',
        fill: true,
        tension: 0.35,
        pointBackgroundColor: '#e8b84b',
        pointBorderColor: '#0a1628',
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0f2040',
          borderColor: 'rgba(232,184,75,0.3)',
          borderWidth: 1,
          callbacks: {
            label: ctx => `Rating: ${ctx.raw}`
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#8899bb', font: { size: 10 }, maxRotation: 25, maxTicksLimit: 8 },
          grid:  { color: 'rgba(255,255,255,0.05)' }
        },
        y: {
          ticks: { color: '#8899bb', font: { size: 11 } },
          grid:  { color: 'rgba(255,255,255,0.05)' }
        }
      }
    }
  });
}

function backToRankings() { showPage('rankings'); }

function showPTab(btn, tabId) {
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.ptab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tabId).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RATING CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POINT_TABLE = [
  { maxDiff: 24,       fav: 8, underdog: 8  },
  { maxDiff: 49,       fav: 7, underdog: 10 },
  { maxDiff: 99,       fav: 5, underdog: 12 },
  { maxDiff: 149,      fav: 3, underdog: 15 },
  { maxDiff: 199,      fav: 2, underdog: 20 },
  { maxDiff: 249,      fav: 1, underdog: 26 },
  { maxDiff: Infinity, fav: 0, underdog: 32 },
];

function getPoints(rA, rB, winnerIsA) {
  const diff  = Math.abs(rA - rB);
  const row   = POINT_TABLE.find(r => diff <= r.maxDiff);
  const aIsFav = rA >= rB;
  if (winnerIsA) {
    const pts = aIsFav ? row.fav : row.underdog;
    return { aGain: pts, bGain: -pts };
  } else {
    const pts = aIsFav ? row.underdog : row.fav;
    return { aGain: -pts, bGain: pts };
  }
}

let matchRows = 0;
// Accumulate calculated results for applying to DB
let pendingResults = [];

function addMatchRow() {
  matchRows++;
  const id = matchRows;
  const div = document.createElement('div');
  div.className = 'match-entry';
  div.id = 'mrow' + id;
  div.innerHTML = `
    <div class="field-group">
      <label>Jugador A</label>
      <input type="text" id="pA${id}" placeholder="Nombre" list="playerList" oninput="autoFillRating(${id},'A')">
    </div>
    <div class="field-group" style="min-width:80px">
      <label>Rating A</label>
      <input type="number" id="rA${id}" placeholder="1800">
    </div>
    <div class="vs-badge">VS</div>
    <div class="field-group">
      <label>Jugador B</label>
      <input type="text" id="pB${id}" placeholder="Nombre" list="playerList" oninput="autoFillRating(${id},'B')">
    </div>
    <div class="field-group" style="min-width:80px">
      <label>Rating B</label>
      <input type="number" id="rB${id}" placeholder="1750">
    </div>
    <div class="field-group winner-select" style="min-width:120px">
      <label>Ganador</label>
      <select id="win${id}">
        <option value="A">A gan√≥</option>
        <option value="B">B gan√≥</option>
      </select>
    </div>`;
  document.getElementById('matchEntries').appendChild(div);
}

function autoFillRating(rowId, side) {
  const nameEl   = document.getElementById(`p${side}${rowId}`);
  const ratingEl = document.getElementById(`r${side}${rowId}`);
  if (!nameEl || !ratingEl) return;
  const player = PLAYER_BY_NAME[nameEl.value.trim().toLowerCase()];
  if (player) ratingEl.value = player.rating;
}

function buildDatalist() {
  let dl = document.getElementById('playerList');
  if (!dl) { dl = document.createElement('datalist'); dl.id = 'playerList'; document.body.appendChild(dl); }
  dl.innerHTML = '';
  PLAYERS.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.name;
    dl.appendChild(opt);
    PLAYER_BY_NAME[p.name.toLowerCase()] = p;
  });
}

function renderPendingResults() {
  const body = document.getElementById('calcResultBody');
  body.innerHTML = pendingResults.map(r => `
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pA ? 'üëë ' : ''}<strong>${r.pA}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rA} ‚Üí ${r.rA + r.aGain}</span>
        ${!r.idA ? '<span style="color:var(--orange);font-size:11px"> ‚ö† no en BD</span>' : ''}
      </div>
      <div class="result-pts ${r.aGain >= 0 ? 'gain' : 'loss'}">${r.aGain >= 0 ? '+' : ''}${r.aGain}</div>
    </div>
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pB ? 'üëë ' : ''}<strong>${r.pB}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rB} ‚Üí ${r.rB + r.bGain}</span>
        ${!r.idB ? '<span style="color:var(--orange);font-size:11px"> ‚ö† no en BD</span>' : ''}
      </div>
      <div class="result-pts ${r.bGain >= 0 ? 'gain' : 'loss'}">${r.bGain >= 0 ? '+' : ''}${r.bGain}</div>
    </div>`).join('<hr style="border-color:var(--border);margin:4px 0">');
  document.getElementById('calcResult').classList.add('show');
}

function calculateRatings() {
  pendingResults = [];
  for (let i = 1; i <= matchRows; i++) {
    const pA  = document.getElementById('pA' + i)?.value.trim();
    const pB  = document.getElementById('pB' + i)?.value.trim();
    const rA  = parseInt(document.getElementById('rA' + i)?.value);
    const rB  = parseInt(document.getElementById('rB' + i)?.value);
    const win = document.getElementById('win' + i)?.value;
    if (!pA || !pB || isNaN(rA) || isNaN(rB)) continue;
    const { aGain, bGain } = getPoints(rA, rB, win === 'A');
    const playerA = PLAYERS.find(p => p.name.toLowerCase() === pA.toLowerCase());
    const playerB = PLAYERS.find(p => p.name.toLowerCase() === pB.toLowerCase());
    pendingResults.push({ pA, pB, rA, rB, aGain, bGain, winner: win === 'A' ? pA : pB, idA: playerA?.id, idB: playerB?.id });
  }

  if (!pendingResults.length) { alert('Ingresa al menos un partido completo.'); return; }
  renderPendingResults();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBIR RESULTADOS ‚Äî flujo 2 pasos
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let subirCsvRows = [];   // parsed rows from the uploaded CSV
let subirPending = [];   // computed pendingResults for subirPage

function subirPaso2() {
  const nombre = document.getElementById('subirTorneoNombre').value.trim();
  const fecha  = document.getElementById('subirTorneoFecha').value;
  const msgEl  = document.getElementById('subirStep1Msg');

  if (!nombre) {
    msgEl.style.color = 'var(--red)';
    msgEl.textContent = 'El nombre del torneo es requerido.';
    return;
  }
  if (!fecha) {
    msgEl.style.color = 'var(--red)';
    msgEl.textContent = 'La fecha del torneo es requerida.';
    return;
  }

  msgEl.textContent = '';
  document.getElementById('subirStep1').style.display = 'none';
  document.getElementById('subirStep2').style.display = '';

  const fechaFmt = new Date(fecha + 'T12:00:00').toLocaleDateString('es-PR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  document.getElementById('subirTorneoInfo').innerHTML =
    `<strong style="color:var(--accent)">üèì ${nombre}</strong> <span style="color:var(--muted);margin-left:8px">${fechaFmt}</span>`;

  // Reset CSV state
  subirCsvRows = [];
  subirPending = [];
  document.getElementById('subirCsvStatus').style.display = 'none';
  document.getElementById('subirProcesarBtn').style.display = 'none';
  document.getElementById('subirResult').classList.remove('show');
  document.getElementById('subirDropLabel').textContent = 'Arrastra tu CSV aqu√≠ o haz clic para seleccionar';
  document.getElementById('subirFileInput').value = '';
}

function subirBack() {
  document.getElementById('subirStep2').style.display = 'none';
  document.getElementById('subirStep1').style.display = '';
}

function subirHandleFile(event) {
  const file = event.target.files[0];
  if (file) subirLoadFile(file);
}

function subirHandleDrop(event) {
  event.preventDefault();
  document.getElementById('subirDropArea').classList.remove('drag-over');
  const file = event.dataTransfer.files[0];
  if (file) subirLoadFile(file);
}

function subirLoadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.trim().split(/\r?\n/);
    const dataLines = lines.filter((l, i) => {
      if (i === 0 && /jugador|player|ganador|winner/i.test(l)) return false;
      return l.trim().length > 0;
    });

    subirCsvRows = dataLines.map(l => {
      const parts = l.split(',').map(s => s.trim());
      return { pA: parts[0] || '', pB: parts[1] || '', win: (parts[2] || 'A').toUpperCase() };
    }).filter(r => r.pA && r.pB);

    const st = document.getElementById('subirCsvStatus');
    st.style.display = 'block';
    if (subirCsvRows.length === 0) {
      st.style.cssText += ';background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:var(--red)';
      st.textContent = 'No se encontraron partidos v√°lidos en el archivo.';
      document.getElementById('subirProcesarBtn').style.display = 'none';
    } else {
      st.style.cssText += ';background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);color:var(--green)';
      st.textContent = `‚úì ${subirCsvRows.length} partido${subirCsvRows.length !== 1 ? 's' : ''} detectado${subirCsvRows.length !== 1 ? 's' : ''} en "${file.name}"`;
      document.getElementById('subirProcesarBtn').style.display = '';
    }
    document.getElementById('subirDropLabel').textContent = file.name;
    document.getElementById('subirResult').classList.remove('show');
  };
  reader.readAsText(file, 'UTF-8');
}

function subirProcesarCsv() {
  if (!subirCsvRows.length) { alert('Primero carga un archivo CSV.'); return; }
  subirPending = [];
  const unknown = [];

  for (const row of subirCsvRows) {
    const pA = ALL_PLAYERS.find(p => p.name.toLowerCase() === row.pA.toLowerCase());
    const pB = ALL_PLAYERS.find(p => p.name.toLowerCase() === row.pB.toLowerCase());
    if (!pA) { unknown.push(row.pA); continue; }
    if (!pB) { unknown.push(row.pB); continue; }
    const { aGain, bGain } = getPoints(pA.rating, pB.rating, row.win === 'A');
    subirPending.push({
      pA: pA.name, pB: pB.name, rA: pA.rating, rB: pB.rating,
      aGain, bGain, winner: row.win === 'A' ? pA.name : pB.name,
      idA: pA.id, idB: pB.id
    });
  }

  if (!subirPending.length) {
    const msg = unknown.length
      ? `No se encontraron en la BD: ${[...new Set(unknown)].join(', ')}`
      : 'No hay partidos v√°lidos para procesar.';
    alert(msg);
    return;
  }

  if (unknown.length) {
    const st = document.getElementById('subirCsvStatus');
    st.style.cssText += ';background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);color:var(--orange)';
    st.textContent = `‚ö† ${subirPending.length} partidos procesados. Jugadores no encontrados: ${[...new Set(unknown)].join(', ')}`;
  }

  // Render preview
  const body = document.getElementById('subirResultBody');
  body.innerHTML = subirPending.map(r => `
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pA ? 'üëë ' : ''}<strong>${r.pA}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rA} ‚Üí ${r.rA + r.aGain}</span>
      </div>
      <div class="result-pts ${r.aGain >= 0 ? 'gain' : 'loss'}">${r.aGain >= 0 ? '+' : ''}${r.aGain}</div>
    </div>
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pB ? 'üëë ' : ''}<strong>${r.pB}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rB} ‚Üí ${r.rB + r.bGain}</span>
      </div>
      <div class="result-pts ${r.bGain >= 0 ? 'gain' : 'loss'}">${r.bGain >= 0 ? '+' : ''}${r.bGain}</div>
    </div>`).join('<hr style="border-color:var(--border);margin:4px 0">');

  document.getElementById('subirResult').classList.add('show');
  document.getElementById('subirApplyBtn').disabled = false;
  document.getElementById('subirApplyBtn').textContent = '‚úì Confirmar y Aplicar a Base de Datos';
  document.getElementById('subirResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

async function subirApplyRatings() {
  if (!currentUser) { showLogin(); return; }
  if (!subirPending.length) return;

  const nombre = document.getElementById('subirTorneoNombre').value.trim();
  const fecha  = document.getElementById('subirTorneoFecha').value;
  const btn    = document.getElementById('subirApplyBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Aplicando...';

  // ‚îÄ‚îÄ Step 1: Create torneo record ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let torneoId = null;
  try {
    const [t] = await sbPost('torneos', { nombre, fecha });
    torneoId = t?.id;
  } catch(e) { console.warn('No se pudo crear torneo:', e.message); }

  // ‚îÄ‚îÄ Step 2: Snapshot W/L per player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Build map: playerId ‚Üí { nombre, club, rating_inicio, rating_fin, ganados, perdidos }
  const snapshotMap = {};
  for (const r of subirPending) {
    const pA = ALL_PLAYERS.find(x => x.id === r.idA);
    const pB = ALL_PLAYERS.find(x => x.id === r.idB);
    if (r.idA && !snapshotMap[r.idA]) snapshotMap[r.idA] = {
      id_jugador: r.idA, nombre: r.pA, club: pA?.club || '',
      rating_inicio: r.rA, rating_fin: r.rA, ganados: 0, perdidos: 0
    };
    if (r.idB && !snapshotMap[r.idB]) snapshotMap[r.idB] = {
      id_jugador: r.idB, nombre: r.pB, club: pB?.club || '',
      rating_inicio: r.rB, rating_fin: r.rB, ganados: 0, perdidos: 0
    };
    const winnerIsA = r.winner === r.pA;
    if (r.idA) {
      snapshotMap[r.idA].rating_fin += r.aGain;
      if (winnerIsA) snapshotMap[r.idA].ganados++; else snapshotMap[r.idA].perdidos++;
    }
    if (r.idB) {
      snapshotMap[r.idB].rating_fin += r.bGain;
      if (!winnerIsA) snapshotMap[r.idB].ganados++; else snapshotMap[r.idB].perdidos++;
    }
  }

  // ‚îÄ‚îÄ Step 3: Apply rating updates + save partidos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let applied = 0;
  const errors = [];

  for (const r of subirPending) {
    if (r.idA) {
      try {
        await sbPatch('Base%20de%20Datos', `%22Member%20ID%22=eq.${r.idA}`, { Rating: r.rA + r.aGain });
        const p = ALL_PLAYERS.find(x => x.id === r.idA);
        if (p) p.rating = r.rA + r.aGain;
        applied++;
      } catch(e) { errors.push(`${r.pA}: ${e.message}`); }
    }
    if (r.idB) {
      try {
        await sbPatch('Base%20de%20Datos', `%22Member%20ID%22=eq.${r.idB}`, { Rating: r.rB + r.bGain });
        const p = ALL_PLAYERS.find(x => x.id === r.idB);
        if (p) p.rating = r.rB + r.bGain;
        applied++;
      } catch(e) { errors.push(`${r.pB}: ${e.message}`); }
    }
    if (torneoId && r.idA && r.idB) {
      try {
        await sbPost('partidos', {
          torneo_id:        torneoId,
          jugador_a_id:     r.idA,
          jugador_b_id:     r.idB,
          ganador:          r.winner === r.pA ? 'A' : 'B',
          rating_a_antes:   r.rA,
          rating_b_antes:   r.rB,
          rating_a_despues: r.rA + r.aGain,
          rating_b_despues: r.rB + r.bGain,
          fecha,
          nombre_a: r.pA,
          nombre_b: r.pB
        });
      } catch(e) { console.warn('Error guardando partido:', e.message); }
    }
  }

  // ‚îÄ‚îÄ Step 4: Batch insert resultados_evento ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (torneoId) {
    const rows = Object.values(snapshotMap).map(s => ({ ...s, id_torneo: torneoId }));
    try {
      // Insert in batches of 50
      for (let i = 0; i < rows.length; i += 50) {
        await sbPost('resultados_evento', rows.slice(i, i + 50));
      }
    } catch(e) { console.warn('Error guardando resultados_evento:', e.message); }
  }

  // ‚îÄ‚îÄ Step 5: Refresh in-memory rankings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ALL_PLAYERS.sort((a, b) => b.rating - a.rating);
  ALL_PLAYERS.forEach((p, i) => { p.rank = i + 1; RANK_BY_ID[p.id] = p.rank; });
  filterPlayers();

  if (errors.length) {
    btn.textContent = `‚ö† ${applied} aplicados, ${errors.length} errores`;
  } else {
    btn.textContent = `‚úÖ ${applied} ratings actualizados ¬∑ ${Object.keys(snapshotMap).length} participantes guardados`;
    subirPending = [];
    subirCsvRows = [];
  }
}

function downloadCsvTemplate() {
  const content = 'Jugador A,Jugador B,Ganador\nJuan Garc√≠a,Pedro Rodr√≠guez,A\nMaria Lopez,Ana Torres,B\n';
  const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'plantilla_partidos.csv';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
}

async function applyRatings() {
  const btn = document.querySelector('#calcResult .btn-primary');
  btn.disabled = true;
  btn.textContent = '‚è≥ Aplicando...';

  const tournName = document.getElementById('tournName')?.value.trim() || 'Torneo sin nombre';
  let errors = [];
  let applied = 0;

  // Create torneo record if we have one
  let torneoId = null;
  try {
    const [torneo] = await sbPost('torneos', { nombre: tournName, fecha: new Date().toISOString().split('T')[0] });
    torneoId = torneo?.id;
  } catch (e) {
    console.warn('No se pudo crear torneo:', e.message);
  }

  for (const r of pendingResults) {
    const newRA = r.rA + r.aGain;
    const newRB = r.rB + r.bGain;

    // Update player A rating
    if (r.idA) {
      try {
        await sbPatch('Base%20de%20Datos', `%22Member%20ID%22=eq.${r.idA}`, { Rating: newRA });
        // Update local cache
        const p = PLAYERS.find(x => x.id === r.idA);
        if (p) p.rating = newRA;
        applied++;
      } catch (e) { errors.push(`${r.pA}: ${e.message}`); }
    }

    // Update player B rating
    if (r.idB) {
      try {
        await sbPatch('Base%20de%20Datos', `%22Member%20ID%22=eq.${r.idB}`, { Rating: newRB });
        const p = PLAYERS.find(x => x.id === r.idB);
        if (p) p.rating = newRB;
        applied++;
      } catch (e) { errors.push(`${r.pB}: ${e.message}`); }
    }

    // Record the match
    if (torneoId && r.idA && r.idB) {
      try {
        await sbPost('partidos', {
          torneo_id: torneoId,
          jugador_a_id: r.idA,
          jugador_b_id: r.idB,
          ganador: r.winner === r.pA ? 'A' : 'B',
          rating_a_antes: r.rA,
          rating_a_despues: newRA,
          rating_b_antes: r.rB,
          rating_b_despues: newRB,
          fecha: new Date().toISOString().split('T')[0]
        });
      } catch (e) { console.warn('No se guard√≥ partido:', e.message); }
    }
  }

  btn.disabled = false;
  btn.textContent = '‚úì Aplicar a Base de Datos';

  if (errors.length) {
    alert(`‚ö†Ô∏è Se aplicaron ${applied} cambios.\n\nErrores:\n${errors.join('\n')}\n\nVerifica los permisos de escritura en Supabase.`);
  } else {
    alert(`‚úÖ ${applied} ratings actualizados en Supabase.\n\nLos cambios son visibles en tiempo real.`);
    document.getElementById('calcResult').classList.remove('show');
    // Re-sort master list and rebuild rank lookup
    ALL_PLAYERS.sort((a, b) => b.rating - a.rating);
    ALL_PLAYERS.forEach((p, i) => { p.rank = i + 1; RANK_BY_ID[p.id] = p.rank; });
    filterPlayers();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBRES√çA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let membFilter = 'all';

function renderMembers() {
  const q = (document.getElementById('membSearchInput')?.value || '').trim().toLowerCase();

  const filtered = MEMBERS.filter(m => {
    if (q && !String(m.name || '').toLowerCase().includes(q)) return false;
    if (membFilter === 'active')  return m.status === 'active';
    if (membFilter === 'warning') return m.status === 'warning';
    if (membFilter === 'no')      return false; // non-members come from PLAYERS
    return true;
  });

  const grid = document.getElementById('membGrid');
  const labels = { active: '‚úÖ Activo', warning: '‚ö†Ô∏è Por Vencer', expired: '‚ùå Expirado' };

  grid.innerHTML = filtered.map(m => {
    const expInfo = m.daysUntilExp !== null
      ? (m.daysUntilExp >= 0
          ? `Vence: ${m.expDate} (${m.daysUntilExp}d)`
          : `Venci√≥: ${m.expDate}`)
      : '‚Äî';
    const editCell = currentUser
      ? `<button class="edit-btn" onclick="openEditMember(${m.id})">‚úè Editar</button>`
      : '<span></span>';
    return `<div class="memb-item">
      <div class="memb-avatar">${initials(m.name)}</div>
      <div>
        <div class="memb-name">${m.name}</div>
        <div class="memb-meta">${m.club !== '‚Äî' ? m.club : (m.pueblo || '‚Äî')}</div>
      </div>
      <div class="memb-date">
        <div style="font-size:11px;color:var(--muted)">${expInfo}</div>
      </div>
      ${editCell}
      <div class="status-pill ${m.status}">${labels[m.status]}</div>
    </div>`;
  }).join('');

  // Non-members from player list
  if (membFilter === 'all' || membFilter === 'no') {
    const noMembers = PLAYERS.filter(p => !p.member && (!q || String(p.name || '').toLowerCase().includes(q)));
    const toShow = membFilter === 'no' ? noMembers : noMembers.slice(0, 12);
    toShow.forEach(p => {
      const div = document.createElement('div');
      div.className = 'memb-item';
      div.style.opacity = '0.65';
      const editCell = currentUser
        ? `<button class="edit-btn" onclick="openEditMember(${p.id})">‚úè Editar</button>`
        : '<span></span>';
      div.innerHTML = `
        <div class="memb-avatar" style="background:rgba(239,68,68,0.15);color:var(--red)">${initials(p.name)}</div>
        <div>
          <div class="memb-name">${p.name}</div>
          <div class="memb-meta">${p.club || 'Sin club'} ¬∑ ‚òÖ ${p.rating}</div>
        </div>
        <div class="memb-date"><div style="font-size:11px;color:var(--muted)">Sin registro</div></div>
        ${editCell}
        <div class="status-pill expired">‚ùå No Miembro</div>`;
      grid.appendChild(div);
    });
  }

  if (grid.innerHTML === '') {
    grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No hay registros en esta categor√≠a.</div>';
  }
}

function setMembFilter(el, val) {
  document.querySelectorAll('#membresia_page .filter-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  membFilter = val;
  renderMembers();
}

function openEditMember(memberId) {
  if (!currentUser) return;

  // Try MEMBERS first; fall back to ALL_PLAYERS for non-members
  const m = MEMBERS.find(x => x.id === memberId);
  const p = ALL_PLAYERS.find(x => x.id === memberId);

  document.getElementById('editMembId').value    = memberId;
  document.getElementById('editMembSub').textContent = `FPRTM #${memberId}`;
  document.getElementById('editMembName').value  = m ? m.name : (p ? p.name : '');
  document.getElementById('editMembEmail').value = m ? (m.email || '') : '';
  document.getElementById('editMembClub').value  = m ? (m.club !== '‚Äî' ? m.club : '') : (p ? (p.club || '') : '');

  // expDate in MEMBERS is already YYYY-MM-DD (from toISOString)
  document.getElementById('editMembExpDate').value = m && m.expDate && m.expDate !== '‚Äî' ? m.expDate : '';

  document.getElementById('editMembRating').value = p ? p.rating : (m ? '' : '');
  document.getElementById('editMembMsg').textContent = '';
  document.getElementById('editMembMsg').style.color = '';
  document.getElementById('editMembSaveBtn').disabled = false;
  document.getElementById('editMembSaveBtn').textContent = 'Guardar';
  document.getElementById('editMembModal').classList.add('open');
}

function closeEditMember() {
  document.getElementById('editMembModal').classList.remove('open');
}

async function saveEditMember() {
  if (!currentUser) { closeEditMember(); return; }

  const id      = Number(document.getElementById('editMembId').value);
  const email   = document.getElementById('editMembEmail').value.trim();
  const club    = document.getElementById('editMembClub').value.trim();
  const expRaw  = document.getElementById('editMembExpDate').value; // YYYY-MM-DD
  const ratingV = document.getElementById('editMembRating').value;
  const rating  = ratingV ? Number(ratingV) : null;

  const msg = document.getElementById('editMembMsg');
  const btn = document.getElementById('editMembSaveBtn');

  if (rating !== null && (rating < 100 || rating > 3000)) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Rating debe estar entre 100 y 3000.';
    return;
  }

  // Convert YYYY-MM-DD ‚Üí MM/DD/YYYY to match the DB format
  let expFormatted = null;
  if (expRaw) {
    const [y, mo, d] = expRaw.split('-');
    expFormatted = `${mo}/${d}/${y}`;
  }

  const body = {};
  body['Email'] = email;
  body['Club']  = club;
  if (expFormatted) body['Expiration Date'] = expFormatted;
  if (rating !== null) body['Rating'] = rating;

  btn.disabled = true;
  btn.textContent = 'Guardando‚Ä¶';
  msg.textContent = '';

  try {
    await sbPatch('Base%20de%20Datos', `%22Member%20ID%22=eq.${id}`, body);

    // Update local MEMBERS cache
    const mi = MEMBERS.findIndex(x => x.id === id);
    if (mi !== -1) {
      if (email !== undefined) MEMBERS[mi].email = email;
      if (club)  MEMBERS[mi].club  = club;
      if (expFormatted) {
        const now = new Date();
        const newExp = new Date(expRaw);
        const days   = Math.floor((newExp - now) / 86400000);
        MEMBERS[mi].expDate      = expRaw;
        MEMBERS[mi].daysUntilExp = days;
        MEMBERS[mi].status       = days < 0 ? 'expired' : days <= 30 ? 'warning' : 'active';
      }
    }
    // Update local ALL_PLAYERS cache
    if (rating !== null) {
      const pi = ALL_PLAYERS.findIndex(p => p.id === id);
      if (pi !== -1) ALL_PLAYERS[pi].rating = rating;
    }

    renderMembers();
    updateStats();
    msg.style.color = 'var(--green)';
    msg.textContent = '¬°Guardado exitosamente!';
    setTimeout(closeEditMember, 1400);
  } catch(e) {
    msg.style.color = 'var(--red)';
    msg.textContent = `Error: ${e.message}`;
    btn.disabled = false;
    btn.textContent = 'Guardar';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR RANKINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportRankings() {
  if (!ALL_PLAYERS.length) { alert('No hay datos cargados. Espera a que cargue la p√°gina.'); return; }
  const headers = ['Rank', 'ID', 'Nombre', 'Sexo', 'Club', 'Rating', 'Miembro'];
  const rows = ALL_PLAYERS.map(p => [
    p.rank,
    p.id,
    p.name,
    p.sex || '',
    p.club || '',
    p.rating,
    p.member ? 'S√≠' : 'No'
  ]);
  const csv = [headers, ...rows]
    .map(r => r.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(','))
    .join('\n');
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rankings_fprtm_${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NUEVO JUGADOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNewPlayerModal() {
  if (!currentUser) { showLogin(); return; }
  document.getElementById('newPlayerFirstName').value = '';
  document.getElementById('newPlayerLastName').value = '';
  document.getElementById('newPlayerSex').value = '';
  document.getElementById('newPlayerClub').value = '';
  document.getElementById('newPlayerRating').value = '1500';
  document.getElementById('newPlayerEmail').value = '';
  document.getElementById('newPlayerExpDate').value = '';
  document.getElementById('newPlayerMsg').textContent = '';
  document.getElementById('newPlayerSaveBtn').disabled = false;
  document.getElementById('newPlayerSaveBtn').textContent = 'Crear Jugador';
  document.getElementById('newPlayerModal').classList.add('open');
}

function hideNewPlayerModal() {
  document.getElementById('newPlayerModal').classList.remove('open');
}

async function saveNewPlayer() {
  if (!currentUser) { hideNewPlayerModal(); return; }
  const firstName = document.getElementById('newPlayerFirstName').value.trim();
  const lastName  = document.getElementById('newPlayerLastName').value.trim();
  const sex       = document.getElementById('newPlayerSex').value;
  const club      = document.getElementById('newPlayerClub').value.trim();
  const ratingVal = document.getElementById('newPlayerRating').value;
  const rating    = ratingVal ? Number(ratingVal) : 1500;
  const email     = document.getElementById('newPlayerEmail').value.trim();
  const expRaw    = document.getElementById('newPlayerExpDate').value;
  const msg       = document.getElementById('newPlayerMsg');
  const btn       = document.getElementById('newPlayerSaveBtn');

  msg.textContent = '';
  if (!firstName || !lastName) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Nombre y apellido son requeridos.';
    return;
  }
  if (rating < 100 || rating > 3000) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Rating debe estar entre 100 y 3000.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Creando...';

  let expFormatted = null;
  if (expRaw) {
    const [y, mo, d] = expRaw.split('-');
    expFormatted = `${mo}/${d}/${y}`;
  }

  const body = { 'First Name': firstName, 'Last Name': lastName, 'Rating': rating };
  if (sex)           body['Sex']             = sex;
  if (club)          body['Club']            = club;
  if (email)         body['Email']           = email;
  if (expFormatted)  body['Expiration Date'] = expFormatted;

  try {
    await sbPost('Base%20de%20Datos', body);
    msg.style.color = 'var(--green)';
    msg.textContent = `¬°${firstName} ${lastName} registrado exitosamente!`;
    btn.textContent = '¬°Creado!';
    ALL_PLAYERS = await loadPlayers();
    ALL_PLAYERS.forEach(p => { RANK_BY_ID[p.id] = p.rank; });
    PLAYERS = ALL_PLAYERS;
    setTimeout(hideNewPlayerModal, 1500);
  } catch(e) {
    msg.style.color = 'var(--red)';
    msg.textContent = `Error: ${e.message}`;
    btn.disabled = false;
    btn.textContent = 'Crear Jugador';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREAR TORNEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNewTournamentModal() {
  if (!currentUser) { showLogin(); return; }
  document.getElementById('newTournamentName').value = '';
  document.getElementById('newTournamentDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('newTournamentMsg').textContent = '';
  document.getElementById('newTournamentSaveBtn').disabled = false;
  document.getElementById('newTournamentSaveBtn').textContent = 'Crear Torneo';
  document.getElementById('newTournamentModal').classList.add('open');
}

function hideNewTournamentModal() {
  document.getElementById('newTournamentModal').classList.remove('open');
}

async function saveNewTournament() {
  if (!currentUser) { hideNewTournamentModal(); return; }
  const nombre = document.getElementById('newTournamentName').value.trim();
  const fecha  = document.getElementById('newTournamentDate').value || new Date().toISOString().split('T')[0];
  const msg    = document.getElementById('newTournamentMsg');
  const btn    = document.getElementById('newTournamentSaveBtn');

  msg.textContent = '';
  if (!nombre) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'El nombre del torneo es requerido.';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Creando...';

  try {
    await sbPost('torneos', { nombre, fecha });
    msg.style.color = 'var(--green)';
    msg.textContent = '¬°Torneo creado! Usa "Subir Resultados" para agregar partidos.';
    btn.textContent = '¬°Creado!';
    setTimeout(hideNewTournamentModal, 1800);
  } catch(e) {
    msg.style.color = 'var(--red)';
    msg.textContent = `Error: ${e.message}`;
    btn.disabled = false;
    btn.textContent = 'Crear Torneo';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDITAR TORNEO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showEditTorneoModal(id, nombre, fecha) {
  if (!isAdmin()) { showLogin(); return; }
  document.getElementById('editTorneoId').value           = id;
  document.getElementById('editTorneoName').value         = nombre;
  document.getElementById('editTorneoDate').value         = fecha || '';
  document.getElementById('editTorneoMsg').textContent    = '';
  document.getElementById('editTorneoSaveBtn').disabled   = false;
  document.getElementById('editTorneoSaveBtn').textContent = 'Guardar Cambios';
  document.getElementById('editTorneoSub').textContent    = nombre;
  document.getElementById('editTorneoModal').classList.add('open');
}

function hideEditTorneoModal() {
  document.getElementById('editTorneoModal').classList.remove('open');
}

async function saveEditTorneo() {
  if (!isAdmin()) { hideEditTorneoModal(); return; }
  const id     = document.getElementById('editTorneoId').value;
  const nombre = document.getElementById('editTorneoName').value.trim();
  const fecha  = document.getElementById('editTorneoDate').value || null;
  const msg    = document.getElementById('editTorneoMsg');
  const btn    = document.getElementById('editTorneoSaveBtn');

  if (!nombre) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'El nombre es requerido.';
    return;
  }
  btn.disabled = true;
  btn.textContent = 'Guardando...';
  msg.textContent = '';

  try {
    await sbPatch('torneos', `id=eq.${id}`, { nombre, fecha });
    // Update local cache
    const cached = allTorneos.find(t => t.id == id);
    if (cached) { cached.nombre = nombre; cached.fecha = fecha; }
    msg.style.color = 'var(--green)';
    msg.textContent = '‚úì Torneo actualizado.';
    setTimeout(() => { hideEditTorneoModal(); loadTorneosList(); }, 900);
  } catch(e) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Error: ' + e.message;
    btn.disabled = false;
    btn.textContent = 'Guardar Cambios';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORRAR TORNEO (con reversi√≥n at√≥mica)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDeleteTorneoModal(id, nombre) {
  if (!isAdmin()) { showLogin(); return; }
  document.getElementById('deleteTorneoId').value              = id;
  document.getElementById('deleteTorneoNameLabel').textContent = nombre;
  document.getElementById('deleteTorneoMsg').textContent       = '';
  document.getElementById('deleteTorneoMsg').style.color       = 'var(--muted)';
  document.getElementById('deleteTorneoConfirmBtn').disabled   = false;
  document.getElementById('deleteTorneoConfirmBtn').textContent = 'S√≠, Borrar y Revertir';
  document.getElementById('deleteTorneoCancelBtn').disabled    = false;
  document.getElementById('deleteTorneoModal').classList.add('open');
}

function hideDeleteTorneoModal() {
  document.getElementById('deleteTorneoModal').classList.remove('open');
}

async function eliminarTorneo() {
  if (!isAdmin()) { hideDeleteTorneoModal(); return; }
  const torneoId = document.getElementById('deleteTorneoId').value;
  const msg      = document.getElementById('deleteTorneoMsg');
  const btnOk    = document.getElementById('deleteTorneoConfirmBtn');
  const btnCx    = document.getElementById('deleteTorneoCancelBtn');

  btnOk.disabled = true;
  btnCx.disabled = true;
  btnOk.textContent = 'Procesando...';
  msg.style.color = 'var(--muted)';

  try {
    // 1. Get participant snapshots for rating reversion
    msg.textContent = 'Consultando participantes...';
    const participaciones = await sbGet(
      'resultados_evento',
      `?id_torneo=eq.${torneoId}&select=id_jugador,rating_inicio`
    );

    // 2. Revert each player's rating to pre-tournament value
    msg.textContent = `Revirtiendo ratings de ${participaciones.length} jugador(es)...`;
    for (const p of participaciones) {
      await sbPatch('jugadores', `id=eq.${p.id_jugador}`, { rating_actual: p.rating_inicio });
    }

    // 3. Cascade deletes
    msg.textContent = 'Eliminando registros asociados...';
    await sbDelete('partidos',          `id_torneo=eq.${torneoId}`);
    await sbDelete('resultados_evento', `id_torneo=eq.${torneoId}`);
    await sbDelete('torneos',           `id=eq.${torneoId}`);

    // 4. Refresh both player list and torneos list
    await loadPlayers();
    msg.style.color = 'var(--green)';
    msg.textContent = `‚úì Torneo eliminado ¬∑ ${participaciones.length} rating(s) revertido(s).`;
    setTimeout(() => { hideDeleteTorneoModal(); loadTorneosList(); }, 1400);

  } catch(e) {
    msg.style.color = 'var(--red)';
    msg.textContent = 'Error: ' + e.message;
    btnOk.disabled = false;
    btnCx.disabled = false;
    btnOk.textContent = 'S√≠, Borrar y Revertir';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showConfigModal() {
  document.getElementById('configModal').classList.add('open');
}

function hideConfigModal() {
  document.getElementById('configModal').classList.remove('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TORNEOS LIST PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allTorneos = [];   // cached list of torneos

async function loadTorneosList() {
  const grid = document.getElementById('torneosGrid');
  if (!grid) return;
  grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">Cargando torneos...</div>';
  try {
    allTorneos = await sbGet('torneos', '?select=id,nombre,fecha&order=fecha.desc&limit=200');
    // Fetch participant counts from resultados_evento grouped by id_torneo
    let countMap = {};
    try {
      const counts = await sbGet('resultados_evento', '?select=id_torneo,id_jugador&limit=10000');
      counts.forEach(r => { countMap[r.id_torneo] = (countMap[r.id_torneo] || 0) + 1; });
    } catch(_) {}

    if (!allTorneos.length) {
      grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No hay torneos registrados a√∫n.</div>';
      return;
    }
    grid.innerHTML = allTorneos.map(t => {
      const count      = countMap[t.id] || 0;
      const safeNombre = t.nombre.replace(/'/g, "\\'");
      const fechaFmt   = t.fecha
        ? new Date(t.fecha + 'T12:00:00').toLocaleDateString('es-PR', { year:'numeric', month:'long', day:'numeric' })
        : '‚Äî';
      const adminBtns = isAdmin() ? `
        <div class="torneo-admin-actions" onclick="event.stopPropagation()">
          <button class="torneo-admin-btn edit" title="Editar torneo"
            onclick="showEditTorneoModal(${t.id},'${safeNombre}','${t.fecha || ''}')">‚úèÔ∏è</button>
          <button class="torneo-admin-btn del" title="Borrar torneo"
            onclick="showDeleteTorneoModal(${t.id},'${safeNombre}')">üóëÔ∏è</button>
        </div>` : `<div style="color:var(--muted);font-size:20px;margin-top:4px">‚Ä∫</div>`;
      return `<div class="torneo-card" onclick="openTorneoEvento(${t.id},'${safeNombre}','${t.fecha || ''}')">
        <div class="torneo-card-left">
          <div class="torneo-card-name">${t.nombre}</div>
          <div class="torneo-card-date">üìÖ ${fechaFmt}</div>
        </div>
        <div class="torneo-card-right">
          ${count ? `<div class="torneo-card-count">${count}</div><div class="torneo-card-label">Jugadores</div>` : '<div class="torneo-card-label" style="color:var(--muted)">Sin datos</div>'}
          ${adminBtns}
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    grid.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Error: ${e.message}</div>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TORNEO EVENTO PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let eventoRows = [];   // full list for current event (for search filter)

async function openTorneoEvento(torneoId, nombre, fecha) {
  showPage('torneoEvento');

  document.getElementById('eventoOverline').textContent = fecha
    ? new Date(fecha + 'T12:00:00').toLocaleDateString('es-PR', { year:'numeric', month:'long', day:'numeric' })
    : 'Torneo';
  document.getElementById('eventoTitle').textContent      = nombre;
  document.getElementById('eventoSubtitle').textContent   = 'Cargando participantes...';
  document.getElementById('eventoParticipantCount').textContent = '‚Ä¶';
  document.getElementById('eventoSearchInput').value      = '';
  document.getElementById('eventoGrid').innerHTML         = '<div style="text-align:center;padding:40px;color:var(--muted)">Cargando resultados...</div>';
  eventoRows = [];

  try {
    const data = await sbGet(
      'resultados_evento',
      `?id_torneo=eq.${torneoId}&order=rating_fin.desc&limit=500`
    );

    eventoRows = data.map((r, i) => ({
      rank:          i + 1,
      nombre:        r.nombre || '‚Äî',
      club:          r.club   || '‚Äî',
      ratingInicio:  r.rating_inicio,
      ratingFin:     r.rating_fin,
      delta:         r.rating_fin - r.rating_inicio,
      ganados:       r.ganados  || 0,
      perdidos:      r.perdidos || 0,
    }));

    document.getElementById('eventoSubtitle').textContent = `${eventoRows.length} participantes`;
    document.getElementById('eventoParticipantCount').textContent = eventoRows.length;
    renderEventoRows(eventoRows);
  } catch(e) {
    document.getElementById('eventoGrid').innerHTML =
      `<div style="text-align:center;padding:40px;color:var(--red)">Error cargando datos: ${e.message}</div>`;
  }
}

function renderEventoRows(rows) {
  const grid = document.getElementById('eventoGrid');
  if (!rows.length) {
    grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">Sin participantes registrados para este torneo.</div>';
    return;
  }
  grid.innerHTML = rows.map((r, i) => {
    const deltaClass = r.delta > 0 ? 'gain' : r.delta < 0 ? 'loss' : 'tie';
    const deltaSign  = r.delta > 0 ? '‚ñ≤ +' : r.delta < 0 ? '‚ñº ' : '= ';
    const total      = r.ganados + r.perdidos;
    return `<div class="evento-row">
      <div class="evento-rank">${i + 1}</div>
      <div class="evento-player">
        <div class="evento-player-name">${r.nombre}</div>
        <div class="evento-player-meta">${r.club}</div>
      </div>
      <div class="evento-rating-flow">
        <span class="evento-rating-val" style="color:var(--muted)">${r.ratingInicio}</span>
        <span class="evento-arrow">‚Üí</span>
        <span class="evento-rating-val" style="font-weight:600">${r.ratingFin}</span>
      </div>
      <div class="evento-delta ${deltaClass}">${deltaSign}${Math.abs(r.delta)}</div>
      <div class="evento-record">
        <span class="w">${r.ganados}W</span> <span class="l">${r.perdidos}L</span>
        <div style="color:var(--muted);font-size:11px">${total} partidos</div>
      </div>
    </div>`;
  }).join('');
}

function filterEventoRows() {
  const q = document.getElementById('eventoSearchInput').value.trim().toLowerCase();
  const filtered = q.length >= 2
    ? eventoRows.filter(r => r.nombre.toLowerCase().includes(q) || (r.club || '').toLowerCase().includes(q))
    : eventoRows;
  renderEventoRows(filtered);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER / SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let searchTimeout = null;

// Filters entirely in memory from ALL_PLAYERS (the full 600-player master list).
// Never re-fetches from Supabase so non-members are never excluded by gender chips.
function filterPlayers() {
  console.log("Lista maestra:", ALL_PLAYERS.length, "jugadores");
  if (!ALL_PLAYERS || ALL_PLAYERS.length === 0) {
    console.error("filterPlayers: ALL_PLAYERS est√° vac√≠a ‚Äî datos a√∫n no cargados.");
    return;
  }

  const q = document.getElementById('searchInput').value.trim().toLowerCase();

  // Always start from the complete master list ‚Äî never from a pre-filtered subset.
  let results = [...ALL_PLAYERS];

  // Gender chip: strict match ‚Äî only 'masc' in Masculino, only 'fem' in Femenino.
  // Players with no recognizable sex (sexGroup = '') appear only in Todos.
  if (currentFilter === 'masc') {
    results = results.filter(p => playerSexGroup(p) === 'masc');
  } else if (currentFilter === 'fem') {
    results = results.filter(p => playerSexGroup(p) === 'fem');
  }

  console.log(`Filtro '${currentFilter}' ‚Üí ${results.length} jugadores`);

  // Text search (min 2 chars) applied on top of gender filter.
  if (q.length >= 2) {
    results = results.filter(p => String(p.name || '').toLowerCase().includes(q));
    console.log(`B√∫squeda '${q}' ‚Üí ${results.length} jugadores`);
  }

  PLAYERS = results;
  displayedCount = PAGE_SIZE;
  renderPlayers(PLAYERS.slice(0, PAGE_SIZE));
  const lm = document.getElementById('loadMore');
  if (lm) lm.style.display = PLAYERS.length > displayedCount ? '' : 'none';
  updateStats();
}

function setFilter(el, val) {
  document.querySelectorAll('#rankingsPage .filter-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  currentFilter = val;
  filterPlayers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', async () => {
  // Restore auth session if user was previously signed in
  const { data: { session } } = await _supabase.auth.getSession();
  currentUser = session?.user || null;
  updateAuthUI();

  // Keep auth state in sync across tabs
  _supabase.auth.onAuthStateChange((_event, sess) => {
    currentUser = sess?.user || null;
    updateAuthUI();
  });

  Object.values(pages).forEach(id => {
    const el = document.getElementById(id);
    if (el && id !== 'rankingsPage') el.style.display = 'none';
  });

  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterPlayers, 350);
  });

  showLoading(true);
  const [playersResult, membersResult] = await Promise.allSettled([loadPlayers(), loadMembers()]);
  if (playersResult.status === 'fulfilled') {
    ALL_PLAYERS = playersResult.value;
    ALL_PLAYERS.forEach(p => { RANK_BY_ID[p.id] = p.rank; });
    PLAYERS = ALL_PLAYERS;
  } else {
    console.error('Error cargando jugadores:', playersResult.reason);
    showLoading(false);
    showError(`No se pudo conectar a Supabase.<br><small style="font-family:monospace">${playersResult.reason.message}</small>`);
    ALL_PLAYERS = []; PLAYERS = [];
  }
  if (membersResult.status === 'fulfilled') {
    MEMBERS = membersResult.value;
  } else {
    console.error('Error cargando miembros:', membersResult.reason);
    MEMBERS = [];
  }
  showLoading(false);

  displayedCount = PAGE_SIZE;
  renderPlayers(PLAYERS.slice(0, PAGE_SIZE));
  const lm = document.getElementById('loadMore');
  if (lm) lm.style.display = PLAYERS.length > PAGE_SIZE ? '' : 'none';

  buildDatalist();
  addMatchRow();
  renderMembers();
  updateStats();
});
</script>
</body>
</html>
