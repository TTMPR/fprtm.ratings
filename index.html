<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPRTM ‚Äî Sistema de Ratings y Membres√≠a</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
  :root {
    --navy: #0a1628;
    --navy2: #0f2040;
    --blue: #1a3a6e;
    --accent: #e8b84b;
    --accent2: #f4d078;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f97316;
    --text: #f0f4ff;
    --muted: #8899bb;
    --border: rgba(255,255,255,0.08);
    --card: rgba(255,255,255,0.04);
    --card2: rgba(255,255,255,0.07);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--navy);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* BG texture */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background: 
      radial-gradient(ellipse 80% 50% at 10% 0%, rgba(26,58,110,0.4) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 90% 100%, rgba(232,184,75,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,22,40,0.95);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }

  .logo {
    display: flex; flex-direction: column; align-items: flex-start; gap: 4px;
  }
  .fprtm-logo-img {
    height: 52px; width: auto; display: block; object-fit: contain;
  }
  .fprtm-logo-sub {
    font-size: 10px; letter-spacing: 2px; color: var(--muted);
    text-transform: uppercase; font-weight: 600;
  }

  nav { display: flex; gap: 4px; }
  nav button {
    background: none; border: none; color: var(--muted);
    padding: 8px 16px; border-radius: 8px; cursor: pointer;
    font-family: 'DM Sans'; font-size: 14px; font-weight: 500;
    transition: all 0.2s;
  }
  nav button:hover { color: var(--text); background: var(--card2); }
  nav button.active { color: var(--accent); background: rgba(232,184,75,0.1); }

  .admin-btn {
    background: var(--accent) !important;
    color: var(--navy) !important;
    font-weight: 700 !important;
    padding: 8px 20px !important;
  }
  .admin-btn:hover { background: var(--accent2) !important; }

  /* ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ */
  .page { display: none; position: relative; z-index: 1; }
  .page.active { display: block; animation: fadeUp 0.3s ease; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .container { max-width: 1200px; margin: 0 auto; padding: 40px 32px; }

  /* ‚îÄ‚îÄ‚îÄ PAGE HERO ‚îÄ‚îÄ‚îÄ */
  .page-hero {
    padding: 48px 32px 32px;
    max-width: 1200px; margin: 0 auto;
  }
  .page-hero .overline {
    font-family: 'DM Mono'; font-size: 11px; letter-spacing: 3px;
    color: var(--accent); text-transform: uppercase; margin-bottom: 8px;
  }
  .page-hero h1 {
    font-family: 'Bebas Neue'; font-size: 56px; letter-spacing: 3px;
    line-height: 1; color: var(--text);
  }
  .page-hero p { color: var(--muted); margin-top: 8px; font-size: 15px; }

  /* ‚îÄ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ‚îÄ */
  .search-wrap {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 32px;
  }
  .search-box {
    display: flex; gap: 12px; align-items: center;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 20px;
    transition: border-color 0.2s;
  }
  .search-box:focus-within { border-color: var(--accent); }
  .search-box input {
    background: none; border: none; outline: none;
    color: var(--text); font-family: 'DM Sans'; font-size: 15px;
    flex: 1;
  }
  .search-box input::placeholder { color: var(--muted); }
  .search-icon { color: var(--muted); font-size: 18px; }

  /* ‚îÄ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ‚îÄ */
  .filters {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 24px;
    display: flex; gap: 8px; flex-wrap: wrap;
  }
  .filter-chip {
    padding: 6px 16px; border-radius: 99px;
    border: 1px solid var(--border);
    background: var(--card); color: var(--muted);
    cursor: pointer; font-size: 13px; font-weight: 500;
    transition: all 0.2s;
  }
  .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
  .filter-chip.on { background: rgba(232,184,75,0.15); border-color: var(--accent); color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ STATS ROW ‚îÄ‚îÄ‚îÄ */
  .stats-row {
    max-width: 1200px; margin: 0 auto; padding: 0 32px 32px;
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px;
  }
  .stat-card .label { font-size: 12px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; }
  .stat-card .value { font-family: 'Bebas Neue'; font-size: 36px; color: var(--text); line-height: 1; }
  .stat-card .sub { font-size: 12px; color: var(--muted); margin-top: 4px; }
  .stat-card.gold { border-color: rgba(232,184,75,0.3); }
  .stat-card.gold .value { color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ PLAYER GRID ‚îÄ‚îÄ‚îÄ */
  .player-grid {
    max-width: 1200px; margin: 0 auto; padding: 0 32px;
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
  }

  .player-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px; padding: 20px 24px;
    display: flex; align-items: center; gap: 16px;
    cursor: pointer; transition: all 0.2s;
    position: relative; overflow: hidden;
  }
  .player-card::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0;
    width: 3px; background: transparent; transition: background 0.2s;
  }
  .player-card:hover { background: var(--card2); border-color: rgba(255,255,255,0.15); transform: translateY(-1px); }
  .player-card:hover::before { background: var(--accent); }
  .player-card.no-member { border-color: rgba(239,68,68,0.2); }
  .player-card.no-member::before { background: var(--red); }

  .rank-num {
    font-family: 'Bebas Neue'; font-size: 28px; color: var(--muted);
    min-width: 36px; text-align: center; line-height: 1;
  }
  .rank-num.top3 { color: var(--accent); }

  .avatar {
    width: 48px; height: 48px; border-radius: 50%;
    background: linear-gradient(135deg, var(--blue), var(--navy2));
    border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 18px; color: var(--accent);
    flex-shrink: 0;
  }

  .player-info { flex: 1; min-width: 0; }
  .player-name { font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .player-meta { font-size: 12px; color: var(--muted); margin-top: 3px; }

  .player-right { text-align: right; flex-shrink: 0; }
  .rating-num {
    font-family: 'Bebas Neue'; font-size: 28px; color: var(--text);
    display: flex; align-items: center; gap: 6px; justify-content: flex-end;
  }
  .star { color: var(--accent); font-size: 16px; }
  .player-stats { font-size: 11px; color: var(--muted); margin-top: 2px; font-family: 'DM Mono'; }

  .badge {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 600;
    margin-left: 6px;
  }
  .badge.member { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge.no { background: rgba(239,68,68,0.15); color: var(--red); }

  /* ‚îÄ‚îÄ‚îÄ PLAYER PROFILE ‚îÄ‚îÄ‚îÄ */
  #profilePage { display: none; }
  #profilePage.active { display: block; }

  .profile-hero {
    max-width: 1200px; margin: 0 auto; padding: 40px 32px;
    display: grid; grid-template-columns: 280px 1fr; gap: 32px; align-items: start;
  }

  .profile-card {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 24px; text-align: center;
  }
  .profile-avatar {
    width: 100px; height: 100px; border-radius: 50%;
    background: linear-gradient(135deg, var(--blue), var(--accent));
    margin: 0 auto 16px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 36px; color: white;
    border: 3px solid var(--accent);
  }
  .profile-name { font-family: 'Bebas Neue'; font-size: 32px; letter-spacing: 1px; line-height: 1.1; }
  .profile-id { font-family: 'DM Mono'; font-size: 13px; color: var(--accent); margin-top: 4px; }
  .profile-club { font-size: 13px; color: var(--muted); margin-top: 6px; }

  .profile-rating-box {
    margin: 24px 0; padding: 20px;
    background: var(--navy);
    border-radius: 12px; border: 1px solid var(--border);
  }
  .profile-rating-box .big-rating {
    font-family: 'Bebas Neue'; font-size: 64px; color: var(--text); line-height: 1;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .profile-rating-box .rating-label { font-size: 12px; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; }

  .profile-quick-stats {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 16px;
  }
  .qs { background: var(--navy); border-radius: 8px; padding: 12px;
    font-size: 13px; color: var(--muted); }
  .qs strong { display: block; font-family: 'Bebas Neue'; font-size: 24px; color: var(--text); }

  .profile-right { }
  .profile-tabs {
    display: flex; gap: 4px; border-bottom: 1px solid var(--border);
    padding-bottom: 0; margin-bottom: 24px;
  }
  .ptab {
    background: none; border: none; color: var(--muted);
    padding: 10px 20px 14px; cursor: pointer;
    font-family: 'DM Sans'; font-size: 14px; font-weight: 500;
    border-bottom: 2px solid transparent; margin-bottom: -1px;
    transition: all 0.2s;
  }
  .ptab.active { color: var(--accent); border-bottom-color: var(--accent); }

  .ptab-content { display: none; }
  .ptab-content.active { display: block; }

  /* overview stats */
  .overview-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;
  }
  .ov-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px 20px; text-align: center;
  }
  .ov-card .lbl { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; }
  .ov-card .val { font-family: 'Bebas Neue'; font-size: 36px; margin-top: 4px; }
  .val.green { color: var(--green); }
  .val.red { color: var(--red); }
  .val.gold { color: var(--accent); }

  /* win % circle */
  .winpct-row { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
  .circle-wrap { position: relative; width: 80px; height: 80px; flex-shrink: 0; }
  .circle-wrap svg { transform: rotate(-90deg); }
  .circle-val {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 18px; color: var(--accent);
  }

  /* tournament history */
  .tourn-list { display: flex; flex-direction: column; gap: 10px; }
  .tourn-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px;
    display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;
  }
  .tourn-name { font-weight: 600; font-size: 14px; }
  .tourn-date { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .tourn-right { text-align: right; }
  .rating-change {
    font-family: 'DM Mono'; font-size: 14px; font-weight: 600;
  }
  .rating-change.up { color: var(--green); }
  .rating-change.dn { color: var(--red); }
  .tourn-matches { font-size: 12px; color: var(--muted); margin-top: 3px; }

  /* match list */
  .match-list { display: flex; flex-direction: column; gap: 8px; }
  .match-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 20px;
    display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;
  }
  .match-player { }
  .match-player .name { font-size: 13px; font-weight: 600; }
  .match-player .rating-tag { font-size: 11px; color: var(--muted); font-family: 'DM Mono'; }
  .match-player .pts-change { font-family: 'DM Mono'; font-size: 12px; font-weight: 700; }
  .match-player.winner .name { color: var(--accent); }
  .match-player.winner .pts-change { color: var(--green); }
  .match-player.loser .pts-change { color: var(--red); }
  .match-center { text-align: center; }
  .match-score { font-family: 'Bebas Neue'; font-size: 18px; color: var(--text); letter-spacing: 2px; }
  .match-date { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .match-player.right { text-align: right; }

  /* ‚îÄ‚îÄ‚îÄ RATING CALCULATOR ‚îÄ‚îÄ‚îÄ */
  .calc-wrap {
    max-width: 800px; margin: 0 auto; padding: 0 32px 40px;
  }
  .upload-zone {
    border: 2px dashed var(--border); border-radius: 16px;
    padding: 48px; text-align: center; cursor: pointer;
    transition: all 0.2s; margin-bottom: 32px;
    background: var(--card);
  }
  .upload-zone:hover { border-color: var(--accent); background: rgba(232,184,75,0.05); }
  .upload-icon { font-size: 48px; margin-bottom: 16px; }
  .upload-zone h3 { font-family: 'Bebas Neue'; font-size: 24px; letter-spacing: 2px; }
  .upload-zone p { color: var(--muted); font-size: 13px; margin-top: 8px; }

  .manual-entry {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px;
  }
  .manual-entry h3 { font-family: 'Bebas Neue'; font-size: 22px; letter-spacing: 2px; margin-bottom: 20px; }

  .match-entry {
    display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 12px; align-items: end;
    margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);
  }
  .match-entry:last-of-type { border-bottom: none; }

  .field-group label { font-size: 11px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 6px; }
  .field-group input, .field-group select {
    width: 100%; background: var(--navy); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 12px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
    transition: border-color 0.2s;
  }
  .field-group input:focus, .field-group select:focus { border-color: var(--accent); }
  .field-group select option { background: var(--navy); }

  .vs-badge {
    font-family: 'Bebas Neue'; font-size: 18px; color: var(--muted);
    padding-bottom: 10px; letter-spacing: 2px;
  }
  .winner-select { align-self: end; }
  .winner-select select { background: var(--navy); }

  .calc-result {
    margin-top: 20px; padding: 20px 24px;
    background: rgba(232,184,75,0.08); border: 1px solid rgba(232,184,75,0.3);
    border-radius: 12px; display: none;
  }
  .calc-result.show { display: block; }
  .calc-result h4 { font-family: 'Bebas Neue'; font-size: 20px; letter-spacing: 2px; color: var(--accent); margin-bottom: 12px; }
  .result-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .result-row:last-child { border-bottom: none; }
  .result-player { font-size: 14px; }
  .result-pts { font-family: 'DM Mono'; font-size: 16px; font-weight: 700; }
  .result-pts.gain { color: var(--green); }
  .result-pts.loss { color: var(--red); }

  .btn-primary {
    background: var(--accent); color: var(--navy);
    border: none; border-radius: 10px; padding: 12px 28px;
    font-family: 'DM Sans'; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: all 0.2s; margin-top: 16px;
  }
  .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); }
  .btn-secondary {
    background: var(--card2); color: var(--text);
    border: 1px solid var(--border); border-radius: 10px; padding: 12px 28px;
    font-family: 'DM Sans'; font-size: 15px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; margin-top: 16px; margin-left: 8px;
  }
  .btn-secondary:hover { border-color: var(--accent); }

  /* ‚îÄ‚îÄ‚îÄ MEMBRES√çA ‚îÄ‚îÄ‚îÄ */
  .memb-grid {
    max-width: 1200px; margin: 0 auto; padding: 0 32px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .memb-item {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 16px 20px;
    display: grid; grid-template-columns: auto 1fr auto auto; gap: 20px; align-items: center;
  }
  .memb-avatar {
    width: 40px; height: 40px; border-radius: 50%;
    background: var(--blue);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue'; font-size: 16px; color: var(--accent);
  }
  .memb-name { font-weight: 600; font-size: 14px; }
  .memb-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .memb-date { font-family: 'DM Mono'; font-size: 13px; color: var(--muted); text-align: right; }
  .memb-date .date { font-size: 12px; }
  .status-pill {
    padding: 4px 12px; border-radius: 99px; font-size: 12px; font-weight: 700;
    white-space: nowrap;
  }
  .status-pill.active { background: rgba(34,197,94,0.15); color: var(--green); }
  .status-pill.warning { background: rgba(249,115,22,0.15); color: var(--orange); }
  .status-pill.expired { background: rgba(239,68,68,0.15); color: var(--red); }

  .alert-banner {
    max-width: 1200px; margin: 0 auto 24px;
    padding: 0 32px;
  }
  .alert-box {
    background: rgba(249,115,22,0.1); border: 1px solid rgba(249,115,22,0.3);
    border-radius: 12px; padding: 14px 20px;
    display: flex; align-items: center; gap: 12px;
    font-size: 14px;
  }
  .alert-box .icon { font-size: 20px; }
  .alert-box strong { color: var(--orange); }

  /* ‚îÄ‚îÄ‚îÄ BACK BUTTON ‚îÄ‚îÄ‚îÄ */
  .back-btn {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-family: 'DM Sans'; font-size: 14px;
    display: flex; align-items: center; gap: 8px;
    padding: 0; margin-bottom: 8px; transition: color 0.2s;
  }
  .back-btn:hover { color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .player-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .profile-hero { grid-template-columns: 1fr; }
    .overview-grid { grid-template-columns: repeat(2, 1fr); }
  }

  /* ‚îÄ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ‚îÄ */
  .table-wrap { max-width: 1200px; margin: 0 auto; padding: 0 32px 40px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th {
    padding: 10px 16px; text-align: left;
    font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--muted); border-bottom: 1px solid var(--border);
  }
  td {
    padding: 14px 16px; font-size: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  tr:hover td { background: var(--card); }
  tr td:first-child { font-family: 'Bebas Neue'; font-size: 20px; color: var(--muted); }

  .scrollhint { text-align: center; color: var(--muted); font-size: 13px; margin: 24px 0; }

  /* ‚îÄ‚îÄ‚îÄ LOGIN MODAL ‚îÄ‚îÄ‚îÄ */
  #loginModal {
    position: fixed; inset: 0; z-index: 9999;
    background: rgba(10,22,40,0.96);
    backdrop-filter: blur(10px);
    display: none; align-items: center; justify-content: center;
  }
  #loginModal.open { display: flex; }
  .login-box {
    background: var(--navy2);
    border: 1px solid var(--border);
    border-radius: 20px; padding: 40px;
    width: 100%; max-width: 420px; margin: 20px;
  }
  .login-box .login-header { text-align: center; margin-bottom: 32px; }
  .login-box .login-header .login-logo {
    font-family: 'Bebas Neue'; font-size: 36px; letter-spacing: 4px; color: var(--accent);
  }
  .login-box .login-header p { font-size: 13px; color: var(--muted); margin-top: 4px; }
  .login-field { margin-bottom: 16px; }
  .login-field label {
    font-size: 11px; color: var(--muted); letter-spacing: 1px;
    text-transform: uppercase; display: block; margin-bottom: 6px;
  }
  .login-field input {
    width: 100%; background: var(--navy); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 16px; color: var(--text);
    font-family: 'DM Sans'; font-size: 14px; outline: none;
    transition: border-color 0.2s;
  }
  .login-field input:focus { border-color: var(--accent); }
  #loginError {
    color: var(--red); font-size: 13px; margin-bottom: 12px;
    display: none; text-align: center;
  }
  .btn-cancel {
    width: 100%; margin-top: 8px; background: none; border: none;
    color: var(--muted); cursor: pointer; font-family: 'DM Sans';
    font-size: 14px; padding: 8px; transition: color 0.2s;
  }
  .btn-cancel:hover { color: var(--text); }

  /* ‚îÄ‚îÄ‚îÄ TTM PR BADGE ‚îÄ‚îÄ‚îÄ */
  .ttmpr-badge {
    display: flex; flex-direction: column; align-items: center; gap: 2px;
    text-decoration: none;
    flex-shrink: 0;
  }
  .ttmpr-powered {
    font-size: 9px; letter-spacing: 0.04em;
    color: var(--text-muted, #888);
    text-transform: lowercase;
  }
  .ttmpr-logo {
    width: 120px; height: auto;
    object-fit: contain; display: block;
  }
  .header-right { display: flex; align-items: center; gap: 10px; }

  /* login/user button in header */
  .login-btn {
    background: none !important; border: 1px solid var(--border) !important;
    color: var(--text) !important; font-weight: 500 !important;
    padding: 8px 18px !important; border-radius: 8px !important;
    cursor: pointer; font-family: 'DM Sans'; font-size: 14px;
    transition: all 0.2s; white-space: nowrap;
  }
  .login-btn:hover { border-color: var(--accent) !important; color: var(--accent) !important; }
  .login-btn.signed-in {
    background: rgba(232,184,75,0.1) !important;
    border-color: rgba(232,184,75,0.3) !important;
    color: var(--accent) !important;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="fprtm-logo.jpg" alt="FPRTM Logo" class="fprtm-logo-img">
    <span class="fprtm-logo-sub">SISTEMA DE RATINGS</span>
  </div>
  <nav>
    <button id="navRankings" class="active" onclick="showPage('rankings')">üèÜ Rankings</button>
    <button id="navCalculator" onclick="showPage('calculator')">‚ö° Calcular Rating</button>
    <button id="navMembresia" style="display:none" onclick="showPage('membresia')">ü™™ Membres√≠a</button>
    <button id="navAdmin" style="display:none" onclick="showPage('admin')">‚öô Admin</button>
  </nav>
  <div class="header-right">
    <a class="ttmpr-badge" href="https://ttmpr.xyz" target="_blank" rel="noopener noreferrer">
      <span class="ttmpr-powered">powered by</span>
      <img class="ttmpr-logo" src="ttmpr-logo.svg" alt="TTM PR logo">
    </a>
    <button class="login-btn" id="loginBtn" onclick="showLogin()">üîê Iniciar Sesi√≥n</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: RANKINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="rankingsPage" class="page active">
  <div class="page-hero">
    <div class="overline">Federaci√≥n Puertorrique√±a de Tenis de Mesa</div>
    <h1>RANKINGS 2026</h1>
    <p>Clasificaci√≥n nacional actualizada ¬∑ Temporada activa</p>
  </div>

  <div class="search-wrap">
    <div class="search-box">
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="Buscar jugador por nombre..." oninput="filterPlayers()">
    </div>
  </div>

  <div class="filters">
    <div class="filter-chip on" onclick="setFilter(this,'all')">Todos</div>
    <div class="filter-chip" onclick="setFilter(this,'masc')">‚ôÇ Masculino Nacional</div>
    <div class="filter-chip" onclick="setFilter(this,'fem')">‚ôÄ Femenino Nacional</div>
    <div class="filter-chip" onclick="setFilter(this,'u21')">Sub-21</div>
    <div class="filter-chip" onclick="setFilter(this,'u19')">Sub-19</div>
    <div class="filter-chip" onclick="setFilter(this,'u15')">Sub-15</div>
    <div class="filter-chip" onclick="setFilter(this,'u13')">Sub-13</div>
    <div class="filter-chip" onclick="setFilter(this,'u11')">Sub-11</div>
    <div class="filter-chip" onclick="setFilter(this,'u9')">Sub-9</div>
    <div class="filter-chip" onclick="setFilter(this,'u7')">Sub-7</div>
    <div class="filter-chip" onclick="setFilter(this,'senior40')">Senior 40+</div>
    <div class="filter-chip" onclick="setFilter(this,'member')">‚úÖ Solo Miembros</div>
  </div>

  <div class="stats-row">
    <div class="stat-card gold">
      <div class="label">Top Rating</div>
      <div class="value" id="statTopRating">‚Äî</div>
      <div class="sub" id="statTopName">Cargando...</div>
    </div>
    <div class="stat-card">
      <div class="label">Jugadores Activos</div>
      <div class="value" id="statTotal">‚Äî</div>
      <div class="sub">En el sistema</div>
    </div>
    <div class="stat-card">
      <div class="label">Miembros 2026</div>
      <div class="value" id="statMembers">‚Äî</div>
      <div class="sub">Registrados</div>
    </div>
    <div class="stat-card">
      <div class="label">Actualizado</div>
      <div class="value" style="font-size:24px;margin-top:6px">Feb 2026</div>
      <div class="sub">En vivo ¬∑ Supabase</div>
    </div>
  </div>

  <div class="player-grid" id="playerGrid"></div>
  <p class="scrollhint" id="loadMore" onclick="loadMorePlayers()" style="cursor:pointer;margin-top:20px;">
    ‚Üì Ver m√°s jugadores
  </p>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: PLAYER PROFILE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="profilePage" class="page">
  <div class="container" style="padding-bottom:0">
    <button class="back-btn" onclick="backToRankings()">‚Üê Volver a Rankings</button>
  </div>

  <div class="profile-hero">
    <div class="profile-card">
      <div class="profile-avatar" id="profileAvatar">JM</div>
      <div class="profile-name" id="profileName">Jerall Montijo</div>
      <div class="profile-id" id="profileId">ATH# ‚Äî</div>
      <div class="profile-club" id="profileClub">Naguabo</div>
      <span id="profileBadge" class="badge member">‚úì Miembro</span>

      <div class="profile-rating-box">
        <div class="rating-label">RATING FPRTM</div>
        <div class="big-rating">
          <span style="color:var(--accent);font-size:32px">‚òÖ</span>
          <span id="profileRating">2132</span>
        </div>
        <div class="rating-label" style="margin-top:4px" id="profileCategory">Juv21U ¬∑ Masculino ¬∑ 20 a√±os</div>
      </div>

      <div class="profile-quick-stats">
        <div class="qs"><strong id="pMatches">‚Äî</strong>Partidos</div>
        <div class="qs"><strong id="pWins" style="color:var(--green)">‚Äî</strong>Victorias</div>
        <div class="qs"><strong id="pLosses" style="color:var(--red)">‚Äî</strong>Derrotas</div>
        <div class="qs"><strong id="pPct" style="color:var(--accent)">‚Äî</strong>Win %</div>
      </div>
    </div>

    <div class="profile-right">
      <div class="profile-tabs">
        <button class="ptab active" onclick="showPTab(this,'overview')">üìä Overview</button>
        <button class="ptab" onclick="showPTab(this,'torneos')">üèì Torneos</button>
        <button class="ptab" onclick="showPTab(this,'partidos')">‚ö° Partidos</button>
      </div>

      <!-- OVERVIEW TAB -->
      <div class="ptab-content active" id="tab-overview">
        <div class="overview-grid">
          <div class="ov-card">
            <div class="lbl">Ranking Nacional</div>
            <div class="val gold" id="ovRank">#2</div>
          </div>
          <div class="ov-card">
            <div class="lbl">Torneos 2026</div>
            <div class="val" id="ovTourneys">3</div>
          </div>
          <div class="ov-card">
            <div class="lbl">Pts Ganados YTD</div>
            <div class="val green" id="ovPtsYTD">+82</div>
          </div>
        </div>

        <div class="winpct-row">
          <div class="circle-wrap">
            <svg width="80" height="80" viewBox="0 0 80 80">
              <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="8"/>
              <circle cx="40" cy="40" r="34" fill="none" stroke="#e8b84b" stroke-width="8"
                stroke-dasharray="213.6" id="winCircle" stroke-dashoffset="64" stroke-linecap="round"/>
            </svg>
            <div class="circle-val" id="winPct">70%</div>
          </div>
          <div>
            <div style="font-size:15px;font-weight:600">Porcentaje de victorias (2026)</div>
            <div style="font-size:13px;color:var(--muted);margin-top:4px">Basado en torneos registrados este a√±o</div>
          </div>
        </div>

        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;">
          <div style="font-size:12px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:12px;">Historial de Rating</div>
          <div style="display:flex;align-items:end;gap:6px;height:60px;">
            <!-- mini bar chart -->
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:45%;position:relative">
              <div style="position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--muted);white-space:nowrap">Ene</div>
            </div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:60%"></div>
            <div style="flex:1;background:var(--accent);border-radius:4px 4px 0 0;height:100%">
              <div style="position:absolute;bottom:-18px;font-size:10px;color:var(--muted)"></div>
            </div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:80%"></div>
            <div style="flex:1;background:var(--blue);border-radius:4px 4px 0 0;height:90%"></div>
          </div>
          <div style="margin-top:24px;display:flex;justify-content:space-between;font-size:11px;color:var(--muted);">
            <span>Rating Inicial 2026: <strong style="color:var(--text)" id="startRating">‚Äî</strong></span>
            <span>Rating Actual: <strong style="color:var(--accent)" id="currentRating">‚Äî</strong></span>
          </div>
        </div>
      </div>

      <!-- TORNEOS TAB -->
      <div class="ptab-content" id="tab-torneos">
        <div class="tourn-list" id="tournList"></div>
      </div>

      <!-- PARTIDOS TAB -->
      <div class="ptab-content" id="tab-partidos">
        <div class="match-list" id="matchList"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: CALCULADORA DE RATING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="calculatorPage" class="page">
  <div class="page-hero">
    <div class="overline">Herramienta</div>
    <h1>CALCULAR RATING</h1>
    <p>Sube foto de resultados o ingresa partidos manualmente</p>
  </div>

  <div class="calc-wrap">
    <div class="upload-zone" onclick="document.getElementById('imgUpload').click()">
      <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
      <div class="upload-icon">üì∏</div>
      <h3>SUBE FOTO DE RESULTADOS</h3>
      <p>Foto de grupos, llaves o tabla de resultados<br>El sistema leer√° los resultados autom√°ticamente</p>
      <button class="btn-primary" style="margin-top:16px;pointer-events:none">Seleccionar imagen</button>
    </div>

    <div class="manual-entry">
      <h3>ENTRADA MANUAL DE PARTIDOS</h3>
      <p style="color:var(--muted);font-size:13px;margin-bottom:20px">Nombre del torneo: <input id="tournName" style="background:var(--navy);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--text);font-family:DM Sans;font-size:13px;outline:none" placeholder="Ej: Clasif. Febrero 2026"></p>

      <div id="matchEntries">
        <!-- Match row template populated by JS -->
      </div>

      <button class="btn-secondary" onclick="addMatchRow()" style="margin-top:0">+ Agregar partido</button>
      <br>
      <button class="btn-primary" onclick="calculateRatings()">‚ö° Calcular Nuevos Ratings</button>

      <div class="calc-result" id="calcResult">
        <h4>RESULTADOS DEL C√ÅLCULO</h4>
        <div id="calcResultBody"></div>
        <button class="btn-primary" style="margin-top:16px" onclick="applyRatings()">‚úì Aplicar a Base de Datos</button>
        <button class="btn-secondary" onclick="document.getElementById('calcResult').classList.remove('show')">Descartar</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: MEMBRES√çA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="membresia_page" class="page">
  <div class="page-hero">
    <div class="overline">Gesti√≥n</div>
    <h1>MEMBRES√çA 2026</h1>
    <p>Control de miembros activos, vencidos y alertas</p>
  </div>

  <div class="alert-banner">
    <div class="alert-box">
      <span class="icon">‚ö†Ô∏è</span>
      <div id="alertText">Cargando estado de membres√≠as...</div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-card gold">
      <div class="label">Miembros Activos</div>
      <div class="value" id="membActive">‚Äî</div>
      <div class="sub">Temporada 2026</div>
    </div>
    <div class="stat-card">
      <div class="label">Sin Membres√≠a</div>
      <div class="value" style="color:var(--red)" id="membNo">‚Äî</div>
      <div class="sub">En ranking pero no miembros</div>
    </div>
    <div class="stat-card">
      <div class="label">Nuevos (Feb)</div>
      <div class="value" style="color:var(--green)" id="membNew">‚Äî</div>
      <div class="sub">Registrados este mes</div>
    </div>
    <div class="stat-card">
      <div class="label">Por Vencer</div>
      <div class="value" style="color:var(--orange)" id="membWarn">‚Äî</div>
      <div class="sub">Pr√≥ximos 30 d√≠as</div>
    </div>
  </div>

  <div class="filters" style="margin-bottom:16px">
    <div class="filter-chip on" onclick="setMembFilter(this,'all')">Todos</div>
    <div class="filter-chip" onclick="setMembFilter(this,'active')">‚úÖ Activos</div>
    <div class="filter-chip" onclick="setMembFilter(this,'warning')">‚ö†Ô∏è Por Vencer</div>
    <div class="filter-chip" onclick="setMembFilter(this,'no')">‚ùå Sin Membres√≠a</div>
  </div>

  <div class="memb-grid" id="membGrid"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE: ADMIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="adminPage" class="page">
  <div class="page-hero">
    <div class="overline">Panel Administrativo</div>
    <h1>ADMIN FPRTM</h1>
    <p>Gesti√≥n de base de datos, torneos y configuraci√≥n</p>
  </div>
  <div class="container">
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showPage('calculator')">
        <div style="font-size:32px;margin-bottom:12px">üì∏</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Subir Resultados</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Foto de torneo ‚Üí calcular y aplicar ratings</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer">
        <div style="font-size:32px;margin-bottom:12px">üìä</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Exportar Rankings</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Descargar Excel actualizado</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer" onclick="showPage('membresia')">
        <div style="font-size:32px;margin-bottom:12px">ü™™</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Gestionar Membres√≠as</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Activar, vencer, alertas</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer">
        <div style="font-size:32px;margin-bottom:12px">‚ûï</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Nuevo Jugador</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Registrar jugador en el sistema</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer">
        <div style="font-size:32px;margin-bottom:12px">üèì</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Crear Torneo</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Nuevo evento en calendario</div>
      </div>
      <div style="background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:24px;cursor:pointer">
        <div style="font-size:32px;margin-bottom:12px">‚öô</div>
        <div style="font-family:'Bebas Neue';font-size:20px;letter-spacing:2px">Configuraci√≥n</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">Tabla de puntos, categor√≠as</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginModal">
  <div class="login-box">
    <div class="login-header">
      <div class="login-logo">FPRTM</div>
      <p>Acceso al panel administrativo</p>
    </div>
    <div class="login-field">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="admin@fprtm.com"
        onkeydown="if(event.key==='Enter')signIn()">
    </div>
    <div class="login-field" style="margin-bottom:24px">
      <label>Contrase√±a</label>
      <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        onkeydown="if(event.key==='Enter')signIn()">
    </div>
    <div id="loginError"></div>
    <button id="loginSubmitBtn" class="btn-primary" style="width:100%;margin-top:0" onclick="signIn()">Entrar</button>
    <button class="btn-cancel" onclick="hideLogin()">Cancelar</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUPABASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://qrvyfdpwtearfpjruwja.supabase.co';
const SUPABASE_KEY = 'sb_publishable_mM59efPqpcgrR3g3_6F_Ww_h1jg4PyV';

// Auth client (supabase-js v2)
const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let currentUser = null;

const SB_HEADERS = {
  'apikey': SUPABASE_KEY,
  'Authorization': `Bearer ${SUPABASE_KEY}`,
  'Content-Type': 'application/json'
};

async function sbGet(table, params = '') {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}${params}`, { headers: SB_HEADERS });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase GET ${table} (${res.status}): ${err}`);
  }
  return res.json();
}

async function sbPatch(table, query, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${query}`, {
    method: 'PATCH',
    headers: { ...SB_HEADERS, 'Prefer': 'return=minimal' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase PATCH ${table} (${res.status}): ${err}`);
  }
}

async function sbPost(table, body) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: { ...SB_HEADERS, 'Prefer': 'return=representation' },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(`Supabase POST ${table} (${res.status}): ${err}`);
  }
  return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAuthUI() {
  const isLoggedIn = !!currentUser;
  ['navMembresia', 'navAdmin'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = isLoggedIn ? '' : 'none';
  });
  const btn = document.getElementById('loginBtn');
  if (!btn) return;
  if (isLoggedIn) {
    btn.textContent = 'üë§ ' + currentUser.email.split('@')[0] + ' ¬∑ Salir';
    btn.classList.add('signed-in');
    btn.onclick = signOut;
  } else {
    btn.textContent = 'üîê Iniciar Sesi√≥n';
    btn.classList.remove('signed-in');
    btn.onclick = showLogin;
  }
}

function showLogin() {
  document.getElementById('loginModal').classList.add('open');
  setTimeout(() => document.getElementById('loginEmail').focus(), 100);
}

function hideLogin() {
  document.getElementById('loginModal').classList.remove('open');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
}

async function signIn() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const errEl    = document.getElementById('loginError');
  const btn      = document.getElementById('loginSubmitBtn');

  errEl.style.display = 'none';
  if (!email || !password) {
    errEl.textContent = 'Ingresa email y contrase√±a.';
    errEl.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Verificando...';

  const { data, error } = await _supabase.auth.signInWithPassword({ email, password });

  btn.disabled = false;
  btn.textContent = 'Entrar';

  if (error) {
    errEl.textContent = 'Credenciales incorrectas. Intenta de nuevo.';
    errEl.style.display = 'block';
    return;
  }

  currentUser = data.user;
  updateAuthUI();
  hideLogin();
}

async function signOut() {
  await _supabase.auth.signOut();
  currentUser = null;
  updateAuthUI();
  showPage('rankings');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA (live from Supabase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let PLAYERS = [];
let MEMBERS = [];
// Cache player lookup by name for calculator autocomplete fill
let PLAYER_BY_NAME = {};

function showLoading(show) {
  let el = document.getElementById('loadingOverlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loadingOverlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(10,22,40,0.9);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px';
    el.innerHTML = `
      <div style="width:48px;height:48px;border:3px solid rgba(232,184,75,0.2);border-top-color:#e8b84b;border-radius:50%;animation:spin 0.8s linear infinite"></div>
      <div style="font-family:Bebas Neue;font-size:20px;letter-spacing:3px;color:#e8b84b">CARGANDO...</div>
      <style>@keyframes spin{to{transform:rotate(360deg)}}</style>`;
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

function showError(msg) {
  document.getElementById('playerGrid').innerHTML = `
    <div style="grid-column:1/-1;text-align:center;padding:40px 20px">
      <div style="font-size:36px;margin-bottom:12px">‚ö†Ô∏è</div>
      <div style="color:var(--red);font-family:'Bebas Neue';font-size:22px;letter-spacing:2px">Error de Conexi√≥n</div>
      <div style="color:var(--muted);font-size:13px;margin-top:8px;max-width:400px;margin-left:auto;margin-right:auto">${msg}</div>
      <button onclick="location.reload()" class="btn-primary" style="margin-top:16px;font-size:13px;padding:8px 20px">‚Ü∫ Reintentar</button>
    </div>`;
}

async function loadPlayers(filter = {}) {
  let params = '?order=rating_actual.desc&limit=600';
  if (filter.sexo)      params += `&sexo=eq.${encodeURIComponent(filter.sexo)}`;
  if (filter.categoria) params += `&categoria=eq.${encodeURIComponent(filter.categoria)}`;
  if (filter.member)    params += `&membresia_status=eq.Miembro`;
  if (filter.search)    params += `&nombre_completo=ilike.*${encodeURIComponent(filter.search)}*`;

  const data = await sbGet('jugadores', params);
  return data.map((p, i) => ({
    id: p.id,
    rank: i + 1,
    name: p.nombre_completo || `${p.primer_nombre || ''} ${p.primer_apellido || ''}`.trim(),
    sex: p.sexo,
    age: p.edad,
    cat: p.categoria,
    club: p.club,
    member: p.membresia_status === 'Miembro',
    rating: p.rating_actual,
    ratingStart: p.rating_inicio_2026 || p.rating_inicio_2025 || p.rating_actual
  }));
}

async function loadMembers() {
  // miembros table columns from real data:
  // nombre_completo, email, telefono, pueblo, ath (Member ID),
  // fecha_membresia (join date), fecha_vencimiento (expiration date)
  // Only fetch non-sensitive columns ‚Äî never expose email, phone, or address publicly
  const data = await sbGet('miembros', '?select=id,nombre_completo,club,sexo,edad,pueblo,ath,fecha_membresia,fecha_vencimiento&order=nombre_completo.asc&limit=300');
  const now = new Date();
  return data.map(m => {
    const nombre = m.nombre_completo || '‚Äî';
    // Use expiration date to determine status (fecha_vencimiento)
    // Fall back to fecha_membresia + 365 days if no expiration stored
    const expDate = m.fecha_vencimiento
      ? new Date(m.fecha_vencimiento)
      : m.fecha_membresia
        ? new Date(new Date(m.fecha_membresia).getTime() + 365 * 86400000)
        : null;

    let status = 'no';
    let daysUntilExp = null;
    if (expDate) {
      daysUntilExp = Math.floor((expDate.getTime() - now.getTime()) / 86400000);
      if (daysUntilExp < 0)        status = 'expired';
      else if (daysUntilExp <= 30) status = 'warning';
      else                          status = 'active';
    }

    return {
      id:     m.id,
      name:   nombre,
      club:   m.club || '‚Äî',
      sex:    m.sexo || '‚Äî',
      age:    m.edad || '‚Äî',
      date:   m.fecha_membresia
                ? m.fecha_membresia.split('T')[0]
                : '‚Äî',
      expDate: expDate
                ? expDate.toISOString().split('T')[0]
                : '‚Äî',
      daysUntilExp,
      status,
      email:  m.email   || '',
      tel:    m.telefono || '',
      pueblo: m.pueblo   || '',
      ath:    m.ath ? '***' : '' // ATH shown only to admin ‚Äî masked here
    };
  });
}

function updateStats() {
  const top = PLAYERS[0] || {};
  document.getElementById('statTopRating').textContent = top.rating || '‚Äî';
  document.getElementById('statTopName').textContent   = top.name
    ? top.name.split(' ').slice(0, 2).join(' ') : '‚Äî';
  document.getElementById('statTotal').textContent   = PLAYERS.length;
  document.getElementById('statMembers').textContent = PLAYERS.filter(p => p.member).length;

  // Membres√≠a page stats
  const active  = MEMBERS.filter(m => m.status === 'active').length;
  const warning = MEMBERS.filter(m => m.status === 'warning').length;
  const noMember = PLAYERS.filter(p => !p.member).length;
  const thisMonth = MEMBERS.filter(m => {
    if (!m.date || m.date === '‚Äî') return false;
    const d = new Date(m.date);
    const now = new Date();
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  }).length;

  const els = {
    membActive: active + warning,
    membNo: noMember,
    membNew: thisMonth,
    membWarn: warning
  };
  Object.entries(els).forEach(([id, val]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  });

  // Alert banner
  const alertEl = document.getElementById('alertText');
  if (alertEl) {
    if (warning > 0) {
      alertEl.innerHTML = `<strong>${warning} membres√≠a${warning>1?'s':''} pr√≥xima${warning>1?'s':''} a vencer</strong> en los pr√≥ximos 30 d√≠as. <span style="color:var(--muted)"> ¬∑ ${noMember} jugadores sin membres√≠a activa.</span>`;
    } else {
      alertEl.innerHTML = `<strong style="color:var(--green)">‚úì Todas las membres√≠as est√°n al d√≠a.</strong> <span style="color:var(--muted)">${noMember} jugadores sin membres√≠a.</span>`;
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const pages = {
  rankings: 'rankingsPage',
  calculator: 'calculatorPage',
  membresia: 'membresia_page',
  admin: 'adminPage',
  profile: 'profilePage'
};

function showPage(key) {
  const PROTECTED = ['membresia', 'admin'];
  if (PROTECTED.includes(key) && !currentUser) {
    showLogin();
    return;
  }

  Object.values(pages).forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.classList.remove('active'); el.style.display = 'none'; }
  });
  const target = document.getElementById(pages[key]);
  if (target) { target.style.display = 'block'; setTimeout(() => target.classList.add('active'), 10); }

  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  const navMap = { rankings: 0, calculator: 1, membresia: 2, admin: 3 };
  if (navMap[key] !== undefined) document.querySelectorAll('nav button')[navMap[key]].classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RANKINGS PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentFilter = 'all';
let displayedCount = 0;
const PAGE_SIZE = 20;

function initials(name) {
  if (!name || name === '‚Äî') return '??';
  return name.split(' ').slice(0, 2).map(w => w[0] || '').join('').toUpperCase();
}

function renderPlayers(list, append = false) {
  const grid = document.getElementById('playerGrid');
  if (!append) grid.innerHTML = '';

  if (!list.length && !append) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted)">No se encontraron jugadores con este filtro.</div>';
    return;
  }

  list.forEach(p => {
    const card = document.createElement('div');
    card.className = 'player-card' + (!p.member ? ' no-member' : '');
    card.onclick = () => showProfile(p);
    card.innerHTML = `
      <div class="rank-num ${p.rank <= 3 ? 'top3' : ''}">#${p.rank}</div>
      <div class="avatar">${initials(p.name)}</div>
      <div class="player-info">
        <div class="player-name">${p.name}
          <span class="badge ${p.member ? 'member' : 'no'}">${p.member ? '‚úì Miembro' : '‚úó No Miembro'}</span>
        </div>
        <div class="player-meta">${p.cat || '‚Äî'} ¬∑ ${p.club || 'Sin club'} ¬∑ ${p.sex || '‚Äî'}</div>
      </div>
      <div class="player-right">
        <div class="rating-num"><span class="star">‚òÖ</span>${p.rating}</div>
        <div class="player-stats">${p.age ? p.age + ' a√±os' : '‚Äî'}</div>
      </div>`;
    grid.appendChild(card);
  });
}

function loadMorePlayers() {
  const next = PLAYERS.slice(displayedCount, displayedCount + PAGE_SIZE);
  renderPlayers(next, true);
  displayedCount += next.length;
  if (displayedCount >= PLAYERS.length) document.getElementById('loadMore').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER PROFILE ‚Äî real data from DB
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showProfile(player) {
  // Reset tabs to overview
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.ptab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.ptab')[0].classList.add('active');
  document.getElementById('tab-overview').classList.add('active');

  // Basic info
  document.getElementById('profileAvatar').textContent = initials(player.name);
  document.getElementById('profileName').textContent   = player.name;
  document.getElementById('profileId').textContent     = 'FPRTM #' + String(player.rank).padStart(4, '0');
  document.getElementById('profileClub').textContent   = player.club || 'Sin club';
  const _badge = document.getElementById('profileBadge');
  _badge.textContent   = player.member ? '‚úì Miembro' : '‚úó No Miembro';
  _badge.className     = 'badge ' + (player.member ? 'member' : 'no');
  _badge.style.display = '';
  document.getElementById('profileRating').textContent = player.rating;
  document.getElementById('profileCategory').textContent =
    [player.cat, player.sex, player.age ? player.age + ' a√±os' : ''].filter(Boolean).join(' ¬∑ ');
  document.getElementById('ovRank').textContent = '#' + player.rank;
  document.getElementById('startRating').textContent   = player.ratingStart || player.rating;
  document.getElementById('currentRating').textContent = player.rating;

  const ytd = player.rating - (player.ratingStart || player.rating);
  document.getElementById('ovPtsYTD').textContent = (ytd >= 0 ? '+' : '') + ytd;

  showPage('profile');

  // Placeholder stats while loading
  document.getElementById('pMatches').textContent = '‚Ä¶';
  document.getElementById('pWins').textContent    = '‚Ä¶';
  document.getElementById('pLosses').textContent  = '‚Ä¶';
  document.getElementById('pPct').textContent     = '‚Ä¶';
  document.getElementById('ovTourneys').textContent = '‚Ä¶';
  document.getElementById('tournList').innerHTML  = '<div style="color:var(--muted);padding:20px">Cargando torneos...</div>';
  document.getElementById('matchList').innerHTML  = '<div style="color:var(--muted);padding:20px">Cargando partidos...</div>';

  // Load real match data
  try {
    const matches = await sbGet('partidos',
      `?or=(jugador_a_id.eq.${player.id},jugador_b_id.eq.${player.id})&order=fecha.desc&limit=50`
    );

    let wins = 0, losses = 0;
    const tourneyMap = {};

    matches.forEach(m => {
      const isA = m.jugador_a_id === player.id;
      const won  = m.ganador === (isA ? 'A' : 'B');
      if (won) wins++; else losses++;
      if (m.torneo_id) {
        if (!tourneyMap[m.torneo_id]) tourneyMap[m.torneo_id] = { wins: 0, losses: 0, torneo_id: m.torneo_id, nombre: m.torneo_nombre || `Torneo #${m.torneo_id}`, fecha: m.fecha };
        if (won) tourneyMap[m.torneo_id].wins++; else tourneyMap[m.torneo_id].losses++;
      }
    });

    const total = wins + losses;
    const pct   = total > 0 ? Math.round(wins / total * 100) : 0;

    document.getElementById('pMatches').textContent = total;
    document.getElementById('pWins').textContent    = wins;
    document.getElementById('pLosses').textContent  = losses;
    document.getElementById('pPct').textContent     = pct + '%';
    document.getElementById('winPct').textContent   = pct + '%';
    document.getElementById('winCircle').style.strokeDashoffset = 213.6 * (1 - pct / 100);

    const tourneys = Object.values(tourneyMap);
    document.getElementById('ovTourneys').textContent = tourneys.length;

    // Render tournaments
    const tl = document.getElementById('tournList');
    if (tourneys.length) {
      tl.innerHTML = tourneys.map(t => `
        <div class="tourn-item">
          <div>
            <div class="tourn-name">${t.nombre}</div>
            <div class="tourn-date">${t.fecha ? new Date(t.fecha).toLocaleDateString('es-PR', {year:'numeric',month:'short',day:'numeric'}) : '‚Äî'}</div>
            <div class="tourn-matches" style="margin-top:6px">
              <span style="color:var(--green)">‚úì ${t.wins} ganados</span> &nbsp;
              <span style="color:var(--red)">‚úó ${t.losses} perdidos</span>
            </div>
          </div>
          <div class="tourn-right">
            <div class="tourn-matches">${t.wins + t.losses} partidos</div>
          </div>
        </div>`).join('');
    } else {
      tl.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">Sin torneos registrados a√∫n.</div>';
    }

    // Render matches
    const ml = document.getElementById('matchList');
    if (matches.length) {
      ml.innerHTML = matches.slice(0, 20).map(m => {
        const isA    = m.jugador_a_id === player.id;
        const myRating = isA ? m.rating_a_antes : m.rating_b_antes;
        const oppName  = isA ? (m.nombre_b || `Jugador #${m.jugador_b_id}`) : (m.nombre_a || `Jugador #${m.jugador_a_id}`);
        const oppRating = isA ? m.rating_b_antes : m.rating_a_antes;
        const myAfter   = isA ? m.rating_a_despues : m.rating_b_despues;
        const pts = (myAfter || myRating) - (myRating || 0);
        const won = m.ganador === (isA ? 'A' : 'B');
        const score = m.resultado || 'VS';
        return `<div class="match-item">
          <div class="match-player ${won ? 'winner' : 'loser'}">
            <div class="name">${won ? 'üëë ' : ''}${player.name.split(' ')[0]}</div>
            <div class="rating-tag">‚òÖ ${myRating || '‚Äî'}</div>
            ${myAfter ? `<div class="pts-change">${pts >= 0 ? '+' : ''}${pts} pts</div>` : ''}
          </div>
          <div class="match-center">
            <div class="match-score">${score}</div>
            <div class="match-date">${m.fecha ? new Date(m.fecha).toLocaleDateString('es-PR',{month:'short',day:'numeric'}) : ''}</div>
          </div>
          <div class="match-player ${!won ? 'winner' : 'loser'} right">
            <div class="name">${!won ? 'üëë ' : ''}${oppName.split(' ')[0]}</div>
            <div class="rating-tag">‚òÖ ${oppRating || '‚Äî'}</div>
          </div>
        </div>`;
      }).join('');
    } else {
      ml.innerHTML = '<div style="color:var(--muted);padding:20px;text-align:center">Sin partidos registrados a√∫n.</div>';
    }

  } catch (e) {
    console.warn('No se pudo cargar historial de partidos:', e.message);
    // Graceful fallback ‚Äî show 0 stats
    document.getElementById('pMatches').textContent = 0;
    document.getElementById('pWins').textContent    = 0;
    document.getElementById('pLosses').textContent  = 0;
    document.getElementById('pPct').textContent     = '‚Äî';
    document.getElementById('ovTourneys').textContent = 0;
    document.getElementById('tournList').innerHTML  = '<div style="color:var(--muted);padding:20px;text-align:center">Sin torneos registrados a√∫n.</div>';
    document.getElementById('matchList').innerHTML  = '<div style="color:var(--muted);padding:20px;text-align:center">Sin partidos registrados a√∫n.</div>';
  }
}

function backToRankings() { showPage('rankings'); }

function showPTab(btn, tabId) {
  document.querySelectorAll('.ptab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.ptab-content').forEach(c => c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-' + tabId).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RATING CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POINT_TABLE = [
  { maxDiff: 24,       fav: 8, underdog: 8  },
  { maxDiff: 49,       fav: 7, underdog: 10 },
  { maxDiff: 99,       fav: 5, underdog: 12 },
  { maxDiff: 149,      fav: 3, underdog: 15 },
  { maxDiff: 199,      fav: 2, underdog: 20 },
  { maxDiff: 249,      fav: 1, underdog: 26 },
  { maxDiff: Infinity, fav: 0, underdog: 32 },
];

function getPoints(rA, rB, winnerIsA) {
  const diff  = Math.abs(rA - rB);
  const row   = POINT_TABLE.find(r => diff <= r.maxDiff);
  const aIsFav = rA >= rB;
  if (winnerIsA) {
    const pts = aIsFav ? row.fav : row.underdog;
    return { aGain: pts, bGain: -pts };
  } else {
    const pts = aIsFav ? row.underdog : row.fav;
    return { aGain: -pts, bGain: pts };
  }
}

let matchRows = 0;
// Accumulate calculated results for applying to DB
let pendingResults = [];

function addMatchRow() {
  matchRows++;
  const id = matchRows;
  const div = document.createElement('div');
  div.className = 'match-entry';
  div.id = 'mrow' + id;
  div.innerHTML = `
    <div class="field-group">
      <label>Jugador A</label>
      <input type="text" id="pA${id}" placeholder="Nombre" list="playerList" oninput="autoFillRating(${id},'A')">
    </div>
    <div class="field-group" style="min-width:80px">
      <label>Rating A</label>
      <input type="number" id="rA${id}" placeholder="1800">
    </div>
    <div class="vs-badge">VS</div>
    <div class="field-group">
      <label>Jugador B</label>
      <input type="text" id="pB${id}" placeholder="Nombre" list="playerList" oninput="autoFillRating(${id},'B')">
    </div>
    <div class="field-group" style="min-width:80px">
      <label>Rating B</label>
      <input type="number" id="rB${id}" placeholder="1750">
    </div>
    <div class="field-group winner-select" style="min-width:120px">
      <label>Ganador</label>
      <select id="win${id}">
        <option value="A">A gan√≥</option>
        <option value="B">B gan√≥</option>
      </select>
    </div>`;
  document.getElementById('matchEntries').appendChild(div);
}

function autoFillRating(rowId, side) {
  const nameEl   = document.getElementById(`p${side}${rowId}`);
  const ratingEl = document.getElementById(`r${side}${rowId}`);
  if (!nameEl || !ratingEl) return;
  const player = PLAYER_BY_NAME[nameEl.value.trim().toLowerCase()];
  if (player) ratingEl.value = player.rating;
}

function buildDatalist() {
  let dl = document.getElementById('playerList');
  if (!dl) { dl = document.createElement('datalist'); dl.id = 'playerList'; document.body.appendChild(dl); }
  dl.innerHTML = '';
  PLAYERS.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.name;
    dl.appendChild(opt);
    PLAYER_BY_NAME[p.name.toLowerCase()] = p;
  });
}

function calculateRatings() {
  pendingResults = [];
  for (let i = 1; i <= matchRows; i++) {
    const pA  = document.getElementById('pA' + i)?.value.trim();
    const pB  = document.getElementById('pB' + i)?.value.trim();
    const rA  = parseInt(document.getElementById('rA' + i)?.value);
    const rB  = parseInt(document.getElementById('rB' + i)?.value);
    const win = document.getElementById('win' + i)?.value;
    if (!pA || !pB || isNaN(rA) || isNaN(rB)) continue;
    const { aGain, bGain } = getPoints(rA, rB, win === 'A');
    const playerA = PLAYERS.find(p => p.name.toLowerCase() === pA.toLowerCase());
    const playerB = PLAYERS.find(p => p.name.toLowerCase() === pB.toLowerCase());
    pendingResults.push({ pA, pB, rA, rB, aGain, bGain, winner: win === 'A' ? pA : pB, idA: playerA?.id, idB: playerB?.id });
  }

  if (!pendingResults.length) { alert('Ingresa al menos un partido completo.'); return; }

  const body = document.getElementById('calcResultBody');
  body.innerHTML = pendingResults.map(r => `
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pA ? 'üëë ' : ''}<strong>${r.pA}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rA} ‚Üí ${r.rA + r.aGain}</span>
        ${!r.idA ? '<span style="color:var(--orange);font-size:11px"> ‚ö† no en BD</span>' : ''}
      </div>
      <div class="result-pts ${r.aGain >= 0 ? 'gain' : 'loss'}">${r.aGain >= 0 ? '+' : ''}${r.aGain}</div>
    </div>
    <div class="result-row">
      <div class="result-player">
        ${r.winner === r.pB ? 'üëë ' : ''}<strong>${r.pB}</strong>
        <span style="color:var(--muted);font-size:12px">${r.rB} ‚Üí ${r.rB + r.bGain}</span>
        ${!r.idB ? '<span style="color:var(--orange);font-size:11px"> ‚ö† no en BD</span>' : ''}
      </div>
      <div class="result-pts ${r.bGain >= 0 ? 'gain' : 'loss'}">${r.bGain >= 0 ? '+' : ''}${r.bGain}</div>
    </div>`).join('<hr style="border-color:var(--border);margin:4px 0">');

  document.getElementById('calcResult').classList.add('show');
}

async function applyRatings() {
  const btn = document.querySelector('#calcResult .btn-primary');
  btn.disabled = true;
  btn.textContent = '‚è≥ Aplicando...';

  const tournName = document.getElementById('tournName')?.value.trim() || 'Torneo sin nombre';
  let errors = [];
  let applied = 0;

  // Create torneo record if we have one
  let torneoId = null;
  try {
    const [torneo] = await sbPost('torneos', { nombre: tournName, fecha: new Date().toISOString().split('T')[0] });
    torneoId = torneo?.id;
  } catch (e) {
    console.warn('No se pudo crear torneo:', e.message);
  }

  for (const r of pendingResults) {
    const newRA = r.rA + r.aGain;
    const newRB = r.rB + r.bGain;

    // Update player A rating
    if (r.idA) {
      try {
        await sbPatch('jugadores', `id=eq.${r.idA}`, { rating_actual: newRA });
        // Update local cache
        const p = PLAYERS.find(x => x.id === r.idA);
        if (p) p.rating = newRA;
        applied++;
      } catch (e) { errors.push(`${r.pA}: ${e.message}`); }
    }

    // Update player B rating
    if (r.idB) {
      try {
        await sbPatch('jugadores', `id=eq.${r.idB}`, { rating_actual: newRB });
        const p = PLAYERS.find(x => x.id === r.idB);
        if (p) p.rating = newRB;
        applied++;
      } catch (e) { errors.push(`${r.pB}: ${e.message}`); }
    }

    // Record the match
    if (torneoId && r.idA && r.idB) {
      try {
        await sbPost('partidos', {
          torneo_id: torneoId,
          jugador_a_id: r.idA,
          jugador_b_id: r.idB,
          ganador: r.winner === r.pA ? 'A' : 'B',
          rating_a_antes: r.rA,
          rating_a_despues: newRA,
          rating_b_antes: r.rB,
          rating_b_despues: newRB,
          fecha: new Date().toISOString().split('T')[0]
        });
      } catch (e) { console.warn('No se guard√≥ partido:', e.message); }
    }
  }

  btn.disabled = false;
  btn.textContent = '‚úì Aplicar a Base de Datos';

  if (errors.length) {
    alert(`‚ö†Ô∏è Se aplicaron ${applied} cambios.\n\nErrores:\n${errors.join('\n')}\n\nVerifica los permisos de escritura en Supabase.`);
  } else {
    alert(`‚úÖ ${applied} ratings actualizados en Supabase.\n\nLos cambios son visibles en tiempo real.`);
    document.getElementById('calcResult').classList.remove('show');
    // Re-sort players
    PLAYERS.sort((a, b) => b.rating - a.rating);
    PLAYERS.forEach((p, i) => p.rank = i + 1);
    displayedCount = PAGE_SIZE;
    renderPlayers(PLAYERS.slice(0, PAGE_SIZE));
  }
}

function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  alert('üì∏ Imagen recibida: ' + file.name + '\n\nFuncionalidad OCR pr√≥ximamente.\nPor ahora ingresa los resultados manualmente.');
  e.target.value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBRES√çA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let membFilter = 'all';

function renderMembers() {
  const filtered = MEMBERS.filter(m => {
    if (membFilter === 'active')  return m.status === 'active';
    if (membFilter === 'warning') return m.status === 'warning';
    if (membFilter === 'no')      return false; // non-members come from PLAYERS
    return true;
  });

  const grid = document.getElementById('membGrid');
  const labels = { active: '‚úÖ Activo', warning: '‚ö†Ô∏è Por Vencer', expired: '‚ùå Expirado' };

  grid.innerHTML = filtered.map(m => {
    const expInfo = m.daysUntilExp !== null
      ? (m.daysUntilExp >= 0
          ? `Vence: ${m.expDate} (${m.daysUntilExp}d)`
          : `Venci√≥: ${m.expDate}`)
      : '‚Äî';
    return `<div class="memb-item">
      <div class="memb-avatar">${initials(m.name)}</div>
      <div>
        <div class="memb-name">${m.name}</div>
        <div class="memb-meta">${m.club !== '‚Äî' ? m.club : (m.pueblo || '‚Äî')}</div>
      </div>
      <div class="memb-date">
        <div style="font-size:11px;color:var(--muted)">${expInfo}</div>
      </div>
      <div class="status-pill ${m.status}">${labels[m.status]}</div>
    </div>`;
  }).join('');

  // Non-members from player list
  if (membFilter === 'all' || membFilter === 'no') {
    const noMembers = PLAYERS.filter(p => !p.member);
    const toShow = membFilter === 'no' ? noMembers : noMembers.slice(0, 12);
    toShow.forEach(p => {
      const div = document.createElement('div');
      div.className = 'memb-item';
      div.style.opacity = '0.65';
      div.innerHTML = `
        <div class="memb-avatar" style="background:rgba(239,68,68,0.15);color:var(--red)">${initials(p.name)}</div>
        <div>
          <div class="memb-name">${p.name}</div>
          <div class="memb-meta">${p.club || 'Sin club'} ¬∑ ‚òÖ ${p.rating}</div>
        </div>
        <div class="memb-date"><div style="font-size:11px;color:var(--muted)">Sin registro</div></div>
        <div class="status-pill expired">‚ùå No Miembro</div>`;
      grid.appendChild(div);
    });
  }

  if (grid.innerHTML === '') {
    grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No hay registros en esta categor√≠a.</div>';
  }
}

function setMembFilter(el, val) {
  document.querySelectorAll('#membresia_page .filter-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  membFilter = val;
  renderMembers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILTER / SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Map each chip key ‚Üí Supabase filter fields.
// Adjust the categoria values here if your DB uses different strings.
const FILTER_MAP = {
  'all':      {},
  'masc':     { sexo: 'Masculino' },
  'fem':      { sexo: 'Femenino'  },
  'u21':      { categoria: 'Sub21'    },
  'u19':      { categoria: 'Sub19'    },
  'u15':      { categoria: 'Sub15'    },
  'u13':      { categoria: 'Sub13'    },
  'u11':      { categoria: 'Sub11'    },
  'u9':       { categoria: 'Sub9'     },
  'u7':       { categoria: 'Sub7'     },
  'senior40': { categoria: 'Senior40' },
  'member':   { member: true          },
};

let searchTimeout = null;

async function filterPlayers() {
  const q = document.getElementById('searchInput').value.trim();
  const filter = { ...(FILTER_MAP[currentFilter] || {}) };
  if (q.length >= 2) filter.search = q;

  try {
    PLAYERS = await loadPlayers(filter);
    displayedCount = PAGE_SIZE;
    renderPlayers(PLAYERS.slice(0, PAGE_SIZE));
    const lm = document.getElementById('loadMore');
    if (lm) lm.style.display = PLAYERS.length > displayedCount ? '' : 'none';
    updateStats();
  } catch (e) {
    console.error(e);
    showError('No se pudo conectar a Supabase. Verifica tu conexi√≥n e intenta de nuevo.');
  }
}

function setFilter(el, val) {
  document.querySelectorAll('#rankingsPage .filter-chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  currentFilter = val;
  filterPlayers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', async () => {
  // Restore auth session if user was previously signed in
  const { data: { session } } = await _supabase.auth.getSession();
  currentUser = session?.user || null;
  updateAuthUI();

  // Keep auth state in sync across tabs
  _supabase.auth.onAuthStateChange((_event, sess) => {
    currentUser = sess?.user || null;
    updateAuthUI();
  });

  Object.values(pages).forEach(id => {
    const el = document.getElementById(id);
    if (el && id !== 'rankingsPage') el.style.display = 'none';
  });

  document.getElementById('searchInput').addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterPlayers, 350);
  });

  showLoading(true);
  try {
    [PLAYERS, MEMBERS] = await Promise.all([loadPlayers(), loadMembers()]);
  } catch (e) {
    console.error('Error cargando datos:', e);
    showLoading(false);
    showError(`No se pudo conectar a Supabase.<br><small style="font-family:monospace">${e.message}</small>`);
    PLAYERS = []; MEMBERS = [];
  }
  showLoading(false);

  displayedCount = PAGE_SIZE;
  renderPlayers(PLAYERS.slice(0, PAGE_SIZE));
  const lm = document.getElementById('loadMore');
  if (lm) lm.style.display = PLAYERS.length > PAGE_SIZE ? '' : 'none';

  buildDatalist();
  addMatchRow();
  renderMembers();
  updateStats();
});
</script>
</body>
</html>
